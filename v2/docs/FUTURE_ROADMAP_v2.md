# Streamnotify on Bluesky - 将来実装機能ロードマップ

本ドキュメントは、**v2 の現在の実装設計**と**最初の構想ドキュメント**（`YouTube新着動画app（初期構想案）`）の
差異を整理し、将来実装すべき機能をロードマップとしてまとめたものです。

> **参考**
> - 現在の実装: `v2 設計仕様書.md`、`v2_design.md` 参照
> - 初期構想: `YouTube新着動画app（初期構想案）` 参照

***

## 1. 対応サービスの拡張

### v2 での実装（完了 ✅）
- ✅ YouTube 新着動画投稿（RSS 方式）
- ✅ YouTube Live 配信開始・終了（youtube_live_plugin.py で実装）
- ✅ ニコニコ動画 動画投稿（niconico_plugin.py で実装）

### 将来実装（TwitchAPI連携プラグイン）

| サービス | 機能 | 優先度 | 実装方式 |
|---------|------|--------|---------|
| **Twitch** | 配信開始・終了検知 | 高 | TwitchAPI連携プラグイン（API または サードパーティ RSS） |

### 実装上の課題
- Twitch: 配信開始・終了の精度（RSS では検出困難）→ API 推奨
- YouTube 動画: API レート制限回避 → RSS+DBの利用でAPI消費を最小限に抑える設計が必須
- YouTube Live: API レート制限回避 → PubSubHubbub 優先設計

***

## 2. データ取得方式の拡張

### v2 での実装
- RSS ポーリング方式（推奨）
- YouTube Data API（YouTubeAPI連携プラグイン）
- ニコニコ動画 RSS（ニコニコ動画プラグイン）

### 将来実装

#### PubSubHubbub サポート（PubSubHubbub連携プラグイン）
- **概要**: RSS の更新を RSS フィード発行元から**プッシュ通知**で受け取る
- **メリット**: リアルタイム検知、ポーリング不要、API 負荷低減
- **対応サービス**: YouTube（公式対応）、一部ブログプラットフォーム

#### Twitch API の導入
- **Twitch**: 配信状態、視聴者数、ゲームタイトル取得

#### tunnel 通信対応（トンネル通信プラグイン）
- **目的**: PubSubHubbub ハブからのプッシュ通知を受信するための外部公開エンドポイントを提供
- TwitchAPIとの通信にエンドポイントが必要な場合にも対応可能
- **必要な構成**:
  - トンネル化（Cloudflare Tunnel / ngrok / localtunnel）
  - HTTP エンドポイント公開
  - PubSubHubbub ハブとのハンドシェイク

***

## 3. 通知先の拡張

### v2 での実装
- **Bluesky のみ** (atproto ライブラリ)

### 将来実装

#### Discord 連携（動画投稿通知機能拡張プラグイン）
- **実装方式**: Webhook または Bot アカウント
- **機能**:
  - チャンネルへの自動投稿
  - 埋め込みメッセージ（Rich Embed）対応
  - ロール メンション、@everyone 対応（オプション）
- **テンプレート**: サービス別・イベント別に独立した投稿テンプレート

#### その他通知先（将来検討）
- Mastodon/misskey（ActivityPub 対応）

***

## 4. 投稿機能の拡張

### v2 での実装
- **テンプレート処理**: Jinja2 形式（YouTube 動画用のみ）
- **テンプレート種別**: 1 種類（YouTube 新着動画）

### プラグインで実装済み（Bluesky 機能拡張プラグイン）

#### マルチテンプレート対応
- **テンプレート別分類**:
  - YouTube: 新着動画、ライブ配信開始、ライブ配信終了（アーカイブ化）
  - Twitch: 配信開始、配信終了
  - ニコニコ: 動画投稿、生放送開始、生放送終了
- **サービス・イベント別の自動選択**: イベント種別を自動判定し、該当テンプレートを適用

#### 画像添付機能
- **概要**: YouTube のサムネイル、配信プレビュー画像の自動ダウンロードと添付
- **対応サービス**: YouTube、Twitch（配信プレビュー画像）
- **ファイル形式**: JPEG、PNG
- **サイズ制限**: 各通知先ごとに最適化

#### リッチテキスト対応
- **Discord**: Rich Embed（色付きメッセージ、フィールド）
- **テンプレート側での制御**: 通知先ごとにマークアップ形式を自動変換

***

## 5. インターフェースの拡張

### v2 での実装
- **CLI**: `python main_v2.py` で起動
- **フル機能版 GUI**（Tkinter）:
  - 動画一覧表示・選択（チェックボックス）
  - 予約投稿日時設定（ダイアログ）
  - 画像ファイル管理（ダイアログ、複数取得方式対応）
  - 投稿実行・ドライラン機能
  - **動画削除機能**（ツールバー + 右クリックメニュー）← 新機能
  - 統計情報表示

### 将来実装（補助機能プラグイン）

#### Web UI（FastAPI + Jinja2）
- **設定管理**:
  - サービス別の監視設定（チャンネル ID、ユーザー名、API キーなど）
  - 通知先設定（Bluesky、Discord）
  - ポーリング間隔、ログレベルなどの詳細設定
- **ダッシュボード**:
  - 直近の動画検知履歴（タイムライン表示）
  - 投稿成功/失敗状況
  - API 使用量の可視化
- **手動操作**:
  - 特定動画の強制投稿
  - 投稿済み状態の手動リセット
  - テンプレートのプレビュー・編集

#### Windows クライアント アプリケーション
- **技術スタック**: PyQt または Tkinter
- **機能**: Web UI と同等の機能を提供
- **メリット**: スタンドアロンで実行可能、常駐化が容易

#### ダークモード対応
- **対応範囲**: Web UI、Windows クライアント
- **テーマ切り替え**: UI 設定から選択可能

***

## 6. デプロイ・運用の拡張

### v2 での実装
- **実行方式**: CLI での手動起動
- **常駐化**: 別途 Windows タスクスケジューラ / systemd 対応が必要（README にヒント記載）

### 将来実装（PubSubHubbub連携プラグイン、トンネル連携プラグイン）

#### トンネル連携（トンネル連携プラグイン）
- **PubSubHubbub/Twitch 用トンネル**:
  - Cloudflare Tunnel（推奨、無料）
  - ngrok（有料オプション）
  - localtunnel（シンプル）
- **自動セットアップ**: トンネル URL の自動生成・登録

***

## 7. データベースの拡張

### v2 での実装
- **SQLite のみ**（ローカルファイル）

### 将来実装（データベース連携プラグイン）

| データベース | 用途 | 優先度 |
|------------|------|--------|
| **PostgreSQL** | マルチユーザー環境、大規模運用 | 中 |
| **MySQL** | VPS/クラウド環境での標準選択肢 | 中 |
| **MongoDB** | ドキュメント型、スケーラビリティ重視 | 低 |
| **Firebase** | バックアップ、クラウド同期 | 低 |

***

## 8. ロギング・監視の拡張

### v2 での実装
- **基本的なログ出力**: コンソール、ファイル（`logs/app.log`）
- **ログレベル**: INFO(デバッグモードOFF)、DEBUG(デバッグモードON)
- **最大ログサイズ**: 10MB
- **バックアップ数**: 5 世代

#### ログ設定拡張プラグインで対応する機能
- **ログレベルの細分化**:ロガー単位でのログレベル設定
- **指定可能な値**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **ログフォーマットのカスタマイズ**: 出力先の選択
- **ログの保存期間設定**: 14日分

### 将来実装
#### 監視・アラート機能
- **Sentry 連携**: エラーの自動レポート
- **Discord への通知**: 重大エラー発生時の即座の通知
- **ヘルスチェック**: API エンドポイント（`/health`）の公開

#### メトリクス収集
- **Prometheus 互換メトリクス**: 投稿数、API レスポンス時間など
- **Grafana ダッシュボード**: リアルタイム可視化

***

## 9. セキュリティ強化

### v2 での実装
- **認証情報の管理**: `settings.env` ファイル（Git 管理外）
- **基本的なバリデーション**: 設定値のチェック

### 将来実装

#### 認証情報の暗号化
- **暗号化方式**: AES-256
- **鍵管理**: マスターパスワード方式 または ハードウェア セキュリティ キー対応

#### アクセス制御（Web UI）
- **ユーザー認証**: パスワード、OAuth2
- **ロールベースアクセス制御（RBAC）**: 管理者、オペレータ、閲覧者

#### API キーの安全な取得
- **初期セットアップウィザード**: ユーザーに対話形式で API キー取得をガイド
- **トークンの自動更新**: 期限切れトークンの自動更新

***

## 10. 実装フェーズと優先度

### Phase 1（v1）
- [✅] **YouTube新着動画投稿**: RSS 方式での新着動画検知・投稿
- [✅] **基本的なCLIインターフェース**: 動作モード選択、ログ出力
- [✅] **SQLiteデータベース**: 動画管理、投稿履歴 保存
- [✅] **Bluesky投稿機能**: atproto ライブラリを使用した投稿機能
- [✅] **GUI**	: 最小限機能のみを実装済み（動画一覧表示、投稿実行）
- [✅] **ロギング設定**: appとerror ログのみ（RotatingFileHandler）
- [✅] **バージョン管理**: app_version.py（v0.1.0）

### Phase 2（v2）
- [✅] **YouTubeLiveプラグイン**: YouTube Live 配信開始・終了検知
- [✅] **YouTubeAPI連携プラグイン**: 複数チャンネル対応、詳細情報取得
- [✅] **Bluesky 機能拡張プラグイン**: 画像添付、投稿テンプレート拡張
- [✅] **サイト連携プラグイン**: ニコニコ動画対応
- [✅] **ログ設定拡張プラグイン**: 詳細ログ設定
- [✅] **GUI 動画削除機能**: DB からの完全削除（ツールバー・右クリックメニュー対応）

### Phase 3（v3）
- [ ] **PubSubHubbub連携プラグイン**: リアルタイム通知
- [ ] **TwitchAPI連携プラグイン**: Twitch 対応
- [ ] **トンネル通信プラグイン**: トンネルサービス連携
- [ ] **Web UI**: 基本的な設定管理画面
- [ ] **Webhook**: PubSubHubbub/Twitch EventSubの実装・統合
- [ ] **GUIのさらなる拡張**: 動画一覧のフィルタ・検索
- [ ] **動画、Live、設定、キャッシュ**: それぞれ別で管理するように実装

### Phase 4（v4以降）
- [ ] **データベース連携プラグイン**: PostgreSQL/MySQL 対応
- [ ] **補助機能プラグイン**: Windowsクライアントアプリケーション、ダークモード/テーマ切替
- [ ] **監視・アラート機能**: Sentry/Prometheus連携、エラー通知
- [ ] **プラグインのホットリロード・動的有効化/無効化**

### Phase 5（v5以降）
- [ ] Mastodon/Bluesky 他 ActivityPub サービス対応（複数通知先への統一実装）


***

## 11. 差異サマリー

### 現在実装（v2）と初期構想の主な相違

| 項目 | 初期構想 | v2 実装 | 差異・注記 |
|------|----------|--------|---------|
| **対応サービス** | Twitch、YouTube Live、ニコニコ | YouTube（RSS・Live）、Niconico対応済み（プラグイン化） | Twitch対応は将来実装予定 |
| **通知先** | Discord、Bluesky | Bluesky のみ | Discord 対応は「動画投稿通知機能拡張プラグイン」で実装予定 |
| **UI** | GUI + CLI + ダークモード | CLI + フル機能版 GUI（tkinter） | ダークモード対応は「補助機能プラグイン」で実装予定 |
| **デプロイ** | トンネル前提 | CLI のみ | トンネルは「トンネル通信プラグイン」で実装予定 |
| **画像添付** | サポート | DB スキーマに対応、GUI で管理可能、投稿実装は「Bluesky 機能拡張プラグイン」対応 |  |
| **API キー管理** | トンネル前提 | `settings.env` ファイル（Git 管理外） | シンプル化、暗号化対応は将来の拡張予定 |
| **バージョン管理** | 未記載 | `app_version.py` で管理、ログに出力 | v2.1.0（実装完了） |
| **複数チャンネル対応** | 未記載 | プラグイン対応 | YouTubeAPI連携プラグインで実装済 |

### 採用した戦略
1. **最小実装から段階的拡張**: v2 は YouTubeとニコニコ動画 → Bluesky に特化
2. **プラグインアーキテクチャ**: 将来の拡張を容易に
3. **構成の簡潔性**: セットアップ手順を最小化、エンドユーザー負荷軽減

***

## 12. 参考資料・検討事項

### 技術参考
- [YouTube Data API v3](https://developers.google.com/youtube/v3)
- [PubSubHubbub 仕様](https://pubsubhubbub.appspot.com/)
- [Twitch API ドキュメント](https://dev.twitch.tv/docs/api)
- [Discord Webhook ガイド](https://discord.com/developers/docs/resources/webhook)
- [LINE Messaging API](https://developers.line.biz/en/services/messaging-api/)

### 検討が必要な項目
1. **API レート制限**: YouTube Data API 10,000 ユニット/日 の制約下での効率的な実装
2. **トンネルセキュリティ**: PubSubHubbub 導入時の HTTPS 化、署名検証
3. **マルチユーザー**: v2 は単一ユーザー前提（複数チャンネル監視は不可）→ 将来の拡張時に検討
4. **オフラインキャッシング**: トンネル障害時の動作保証

## Asset管理と拡張時のファイル追加

- 全サービス・プラグイン用テンプレート/画像は `Asset/` ディレクトリに保管
- プラグイン導入時に必要なファイルのみ本番ディレクトリに自動コピー
- 追加済みファイルはプラグイン削除後も残る
- 将来拡張時は Asset に新規テンプレート/画像を追加し、導入時に自動コピー
