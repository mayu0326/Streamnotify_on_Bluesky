# StreamNotify on Bluesky v2 設計仕様書

本ドキュメントは、**YouTube新着動画自動投稿ボット v2** の実装仕様書です。

> **注記**: 本ドキュメントは、プラグイン未導入のバニラ状態での正常動作を記述しています。  
> 将来的なプラグイン全盛時の完全版仕様は、別途「将来構想ドキュメント」を参照してください。

***

## 1. 対象サービスと検知方法

### v2 で対応するサービス

- **YouTube**
  - 新着動画投稿のみ対応（RSS方式）
  - RSS フィードから通常動画を自動検知

### デフォルトでプラグイン自動ロード対応のサービス

以下のサービスは plugins/ ディレクトリからプラグインが自動的にロードされるため、追加設定なしで対応します：
- **ニコニコ動画** → niconico_plugin.py
- **YouTube Live** → youtube_live_plugin.py
- **ロギング拡張** → logging_plugin.py

### plugins/ ディレクトリが空の場合（手動削除時）に非対応のサービス

- Twitch（TwitchAPI連携プラグイン対応）
- ニコニコ動画（ニコニコ動画プラグイン対応）
- YouTube Live 配信開始・終了検知（YouTubeAPI連携プラグイン対応）

### データ取得方式

- **RSS ポーリング方式（推奨）**
  - YouTube チャンネルの RSS フィードを定期的に取得
  - `POLL_INTERVAL_MINUTES` で指定した間隔（最小 5 分）でポーリング
  - シンプルで安定した方式、追加設定不要

- **YouTube Data API（YouTubeAPI連携プラグイン対応）**
  - 詳細情報取得やライブ配信判別などで活用予定
  - プラグイン導入時のみ有効化可能
  - 動画詳細情報の取得やUC以外のチャンネルIDの監視が可能
  - v2 では RSS フィード取得がデフォルト

***

## 2. 通知先と投稿仕様

### v2 で対応する通知先

- **Bluesky（唯一の通知先）**
  - atproto ライブラリを利用した公式 API 連携
  - YouTube 新着動画の情報を自動投稿

### Bluesky 投稿仕様（バニラ状態 - bluesky_v2.py）

**バニラ状態で対応する機能：**
- **動画情報投稿**: DB に登録された動画情報を自動投稿
- **認証管理**: Bluesky ユーザー名・パスワード認証、Access Token・DID 管理
- **Rich Text Facet 対応**: 投稿テキスト内の URL を自動検出・リンク化（バイト位置と文字位置の正確な計算）
- **ドライラン機能**: `dry_run=True` で実際の投稿をシミュレート（テスト用途）
- **基本的な投稿テンプレート**: source（YouTube/Niconico）に応じた簡単なフォーマット生成
  ```
  【YouTube】
  タイトル
  
  🎬 チャンネル名
  📅 公開日
  
  URL
  
  【Niconico】
  タイトル
  
  📅 公開日
  
  URL
  ```

- **投稿制御**
  - `BLUESKY_POST_ENABLED` で投稿機能を有効/無効化
  - `APP_MODE=dry_run` で強制的にドライランモードに切り替え

- **投稿履歴（バニラ状態）**
  - ログファイル（`logs/app.log`）に投稿結果を記録

### Bluesky 拡張機能（bluesky_plugin.py - プラグイン依存）

**プラグイン（bluesky_plugin.py）で提供される機能：**
- **画像添付機能**: DB 登録済み画像を優先使用、デフォルト画像対応（BLUESKY_IMAGE_PATH）
- **Jinja2 テンプレート処理**: `format_datetime_filter` でテンプレート内の日時をフォーマット
- **複雑なテンプレート機能**: サービス別・イベント別の複数テンプレート対応（オプション）

- **投稿履歴（プラグイン導入時）**
  - ログファイル（`logs/post.log`）に投稿成功結果を記録
  - ログファイル（`logs/post_error.log`）に投稿エラーを記録

### 今後の対応予定

- Discord 連携（動画投稿通知機能拡張プラグイン対応 - 未実装）
- トンネル通信（トンネル通信プラグイン対応 - 未実装）

***

## 3. 利用・運用要件

### 必要環境

- **ハードウェア・ネットワーク**
  - インターネット回線（ポーリングで RSS 取得のため）
  - PC または Linux マシン（常時起動不要、定期実行可能）
  - ドメイン・固定 IP は不要

- **ソフトウェア**
  - Python 3.10 以上
  - Git（リポジトリ clone 用、オプション）

### セットアップの簡潔性

- **設定方法**
  - `settings.env.example` をコピーして `.env` を作成
  - テキストエディタで 4 つの必須項目（YouTube チャンネル ID、Bluesky 認証情報、ポーリング間隔）を編集
  - `python main_v2.py` で起動

- **外部サービス連携**
  - 必須: YouTube チャンネル、Bluesky アカウント

### 操作・UI

- **実行方法**
  - コマンドラインから `python main_v2.py` で起動
  - フル機能版 GUI（Tkinter）が実装済み：動画一覧表示、選択、投稿実行、削除、ドライラン、統計表示。
  - ターミナル出力でログ確認
  - `Ctrl + C` または 管理画面を閉じる と終了できます。

- **設定変更**
  - 手動で `settings.env` を編集
  - 変更後、アプリを再起動して反映

### 動作モード（OperationMode）

アプリケーションは以下4つの動作モードで動作します。`APP_MODE` 環境変数または DB 有無で自動判定されます。

| モード | APP_MODE | 説明 | 投稿機能 |
|--------|----------|------|---------|
| **通常モード** | `normal` | RSS取得＋手動投稿（デフォルト） | 手動のみ |
| **自動投稿モード** | `auto_post` | RSS取得＋自動投稿（5分間隔） | 自動＋手動 |
| **ドライランモード** | `dry_run` | デバッグ用途・投稿シミュレーション | 無効 |
| **収集モード** | `collect` | RSS取得のみ・投稿機能無効 | 無効 |

### 環境変数による拡張設定

#### 必須設定
| 変数名 | 説明 | 例 |
|--------|------|-----|
| `YOUTUBE_CHANNEL_ID` | YouTube チャンネルID（UC で始まる） | `UCxxxxxxxxxx` |
| `BLUESKY_USERNAME` | Bluesky ユーザーハンドル | `yourname.bsky.social` |
| `BLUESKY_PASSWORD` | Bluesky アプリパスワード | `xxxx-xxxx-xxxx-xxxx` |

#### オプション設定
| 変数名 | デフォルト | 説明 |
|--------|-----------|------|
| `APP_MODE` | `normal` | 動作モード（`normal`, `auto_post`, `dry_run`, `collect`） |
| `BLUESKY_POST_ENABLED` | `false` | Bluesky投稿機能の有効化（`true` で有効） |
| `DEBUG_MODE` | `false` | デバッグモード（`true` で有効・全ロガーが DEBUG レベルに） |
| `POLL_INTERVAL_MINUTES` | `10` | YouTubeRSS ポーリング間隔（分）（5〜30分） |
| `TIMEZONE` | `system` | タイムゾーン（`system` またはPyTZ形式） |
| `BLUESKY_IMAGE_PATH` | `images/default/` | デフォルト画像ディレクトリパス（プラグイン用） |
| `YOUTUBE_API_KEY` | - | YouTube Data API キー（YouTubeAPI連携プラグイン用） |
| `NICONICO_USER_ID` | - | ニコニコユーザーID（ニコニコプラグイン用） |
| `NICONICO_LIVE_POLL_INTERVAL` | `10` | ニコニコRSS ポーリング間隔（分）（5〜60分）（ニコニコプラグイン用） |
| `LOG_LEVEL_CONSOLE` | `INFO` | コンソール出力のログレベル (ログ設定拡張プラグイン用) |
| `LOG_LEVEL_FILE` | `DEBUG` | ファイル出力のログレベル (ログ設定拡張プラグイン用) |

#### テンプレートパス（プラグイン用）
| 変数名 | 説明 |
|--------|------|
| `BLUESKY_YOUTUBE_TEMPLATE_PATH` | YouTube動画 新着動画用 テンプレートパス |
| `BLUESKY_YOUTUBE_ONLINE_TEMPLATE_PATH` | YouTubeLive用 開始用テンプレートパス |
| `BLUESKY_YOUTUBE_OFFLINE_TEMPLATE_PATH` | YouTubeLive用 終了用テンプレートパス |
| `BLUESKY_NICONICO_TEMPLATE_PATH` | ニコニコ動画 新着動画用 テンプレートパス |
| `BLUESKY_TWITCH_ONLINE_TEMPLATE_PATH` | Twitch配信用 開始用テンプレートパス |
| `BLUESKY_TWITCH_OFFLINE_TEMPLATE_PATH` | Twitch配信用 終了用テンプレートパス |

### config.py による設定管理

- 環境変数を読み込み、バリデーション実施
- `OperationMode` クラスで動作モード定義（normal, auto_post, dry_run, collect）
- プラグイン有無（`youtube_api_plugin`, `niconico_plugin`）を自動検出
- 起動時に動作モード・Bluesky投稿状態・デバッグモード状態をログ出力
- ポーリング間隔の範囲チェック（5〜30分）

### ロギング設定と拡張機能

#### logging_config.py の役割

- ロギング基盤の一元管理
- ロギングプラグイン（`plugins/logging_plugin.py`）の自動ロード試行
- プラグイン未導入時のデフォルト設定を提供

#### カスタムハンドラー

1. **LFRotatingFileHandler**
   - ログファイルの改行コードを LF に統一
   - Windows 環境での CRLF 混在を防止
   - ファイルサイズ制限：app.log 10MB、error.log 5MB
   - バックアップファイル：app.log 5世代、error.log 3世代

2. **NoExcInfoStreamHandler**
   - コンソール出力のトレースバック（exc_info）を抑制
   - エラー発生時も簡潔なメッセージのみ表示
   - ファイルログには完全なトレースバック情報を記録

#### 動作モード別ログ出力

**デフォルト動作（プラグイン未導入時）**:
- app.log: INFO レベル、改行コード LF
- error.log: WARNING 以上のレベル、トレースバック、改行コード LF
- コンソール: INFO レベル、トレースバック抑制
- デバッグモード有効時: 全て DEBUG レベル、デバッグログはapp.logに記録

**ロギングプラグイン導入時**:
- 複数のロガー（AppLogger, PostLogger, PostErrorLogger, NiconicoLogger, YouTubeLogger, AuditLogger, TunnelLogger）を管理
- 投稿結果：PostLogger が `logs/post.log` に成功を記録
- 投稿エラー：PostErrorLogger が `logs/post_error.log` にエラーを記録
- 環境変数（`LOG_LEVEL_CONSOLE`, `LOG_LEVEL_FILE`）でレベル制御
- 各ロガーが独立したログファイルを使用

### 実装予定の機能

- Web UI（現在は Tkinter GUI のみ）
- ダークモード（GUI 拡張予定）
- トンネルサービス連携(Cloudflare/ngrok/localtunnel)（プラグイン予定）
- 自動インストール機能

### モジュール間の依存関係と自動ロード

#### プラグイン自動検出メカニズム

**plugin_manager.py による自動ロード**:
- `plugins/` ディレクトリをスキャン
- `NotificationPlugin` インターフェースを実装したプラグインを自動検出
- サーバー起動時に全プラグインをロードして有効化
- プラグインの有効化・無効化を動的に制御可能

**環境変数によるプラグイン機能制御**:
- `YOUTUBE_API_KEY`: YouTube API プラグインの有効化
- `NICONICO_USER_ID`: ニコニコプラグインの有効化
- その他テンプレートパスなど

#### 依存関係図

```
main_v2.py
├── config.py（設定読み込み・バリデーション）
├── database.py（SQLite操作）
├── bluesky_v2.py（Bluesky API コア）
├── image_manager.py（画像管理・保存）
├── utils_v2.py（共通関数）
├── youtube_rss.py（RSS取得）
│   └── thumbnails/youtube_thumb_utils.py（依存：YouTubeサムネイル自動DL）
│       ├── image_manager.py（依存）
│       └── database.py（依存）
├── plugin_manager.py（プラグイン管理）
│   └── plugins/
│       ├── bluesky_plugin.py（画像・テンプレート拡張）
│       │   └── bluesky_v2.py（依存）
│       ├── youtube_api_plugin.py（YouTube API連携）
│       │   └── youtube_live_plugin.py（ライブ判定、YouTube APIに依存）
│       ├── niconico_plugin.py（ニコニコ監視）
│       │   ├── image_manager.py（依存：画像保存）
│       │   └── thumbnails/niconico_ogp_utils.py（依存：OGP取得）
│       └── logging_plugin.py（ロギング管理）
├── gui_v2.py（GUI フレーム）
│   └── image_manager.py（依存：画像表示）
└── logging_config.py（ロギング基盤）
```

#### logging_config.py と logging_plugin.py の協働

- `logging_config.py`: 基盤設定・フォールバック機能を提供
- `logging_plugin.py`: 複数ロガー・環境変数制御を実装
- 起動時に `logging_plugin.py` の存在を確認し、利用可能なら自動ロード
- フォールバック: プラグイン未導入時はシンプルな app.log/error.log 構成

***

## 4. 内部アーキテクチャ

### コア構成

- **設定レイヤー（config.py）**
  - `settings.env` ファイルから設定値を読み込み
  - ポーリング間隔（10 分以上）などのバリデーション実施

- **データ取得レイヤー（youtube_rss.py）**
  - YouTube チャンネル ID から RSS URL を生成
  - RSS フィードを定期的にポーリング
  - 新着動画情報（動画 ID、タイトル、公開日時）を抽出
  - サムネイル自動取得（thumbnails/youtube_thumb_utils.py）
    - YouTube の動画 ID からサムネイル URL を生成（複数品質対応：maxres/sd/hq/mq/default）
    - サムネイル画像を `images/YouTube/` に自動ダウンロード
    - DB に画像パスを記録

- **ストレージレイヤー（database.py）**
  - SQLite データベース（`data/video_list.db`）で動画情報を管理
  - 既取得動画の重複判定（`video_id` のユニーク制約）
  - 投稿状態管理：`posted_to_bluesky` フラグ（実際に投稿済みか）、
  　　　　　　　　`selected_for_post` フラグ（投稿対象として選択済みか）
  - マルチプロセスアクセス対策：タイムアウト + WAL モード

- **通知レイヤー（main_v2.py / gui_v2.py → bluesky_v2.py + bluesky_plugin.py）**
  - DB の未投稿動画を取得：`posted_to_bluesky = 0` の動画を抽出
  - 投稿形式生成：
    - バニラ状態：bluesky_v2.py で source（YouTube/Niconico）に応じた一定のテンプレート生成
    （シンプルな形式、テキストのみ）
    - プラグイン導入時：bluesky_plugin.py で Jinja2 テンプレート処理
    （テンプレートパス指定対応、複雑なカスタマイズ可能）
  - Bluesky API で投稿：atproto ライブラリで HTTP API 経由で投稿
  - 画像添付：
    - バニラ状態：画像添付なし（テキスト投稿のみ）
    - プラグイン導入時：bluesky_plugin.py で DB 画像またはデフォルト画像を添付
  - 投稿完了後、DB の `posted_to_bluesky = 1` に更新、`posted_at` にタイムスタンプを記録

- **メインループ（main_v2.py）**
  - 設定読み込み → DB 初期化 → プラグイン初期化 → GUI スレッド起動
  - 無限ループで以下を繰り返す:
    1. YouTube RSS フィード取得・解析
    2. 新着動画判定：DB に登録がない `video_id` を新着動画として検出
    3. サムネイル自動ダウンロード（thumbnails/youtube_thumb_utils.py）
       - 新着動画のサムネイル URL から画像をダウンロード
       - `images/YouTube/` に保存
    4. DB 保存（サムネイル情報を含む）
    5. 収集モード判定：`collect` モードの場合はここで終了
    6. ニコニコプラグイン・YouTube Live プラグインが有効な場合は併行して監視：
       - **ニコニコプラグイン有効時**：
         - ニコニコ RSS フィード取得・解析
         - 新着動画判定：DB に登録がない `video_id` を新着動画として検出
         - ニコニコ動画 OGP イメージ取得（thumbnails/niconico_ogp_utils.py）
         - DB 保存（サムネイル情報を含む）
       - **YouTube Live プラグイン有効時**：
         - YouTube Data API を使用してライブ配信判定
         - ライブ配信開始・終了を検知
    7. 自動投稿モードの場合：選択済みの未投稿動画を `posted_interval` 間隔で Bluesky に投稿
    8. ポーリング間隔分スリープ（1秒単位で stop_event をチェック）
  - 終了時：ニコニコプラグインの監視を停止

### 技術スタック

- **言語**: Python 3.10+
- **フレームワーク**: 標準ライブラリのみ（sqlite3）
- **外部ライブラリ**: 
  - `feedparser` - RSS パース
  - `atproto` - Bluesky API
  - `requests` - HTTP リクエスト
  - `Pillow` - 画像処理（サムネイル保存、リサイズ）
  - `beautifulsoup4` - HTML パース（OGP取得）
  - `python-dotenv` - 環境変数管理
  - `pytz`, `tzlocal` - タイムゾーン処理
  - `jinja2` - テンプレート処理（Bluesky機能拡張プラグイン用）

- **ストレージ**: SQLite（`data/video_list.db`）+
 ログファイル（`logs/app.log`, `logs/error.log`, `logs/post.log`, `logs/post_error.log`）  

***

## 5. 実装状況と今後の拡張

### v2 で実装済みの機能

#### コア機能
- **RSS ポーリング**: YouTube チャンネル RSS の自動監視（POLL_INTERVAL_MINUTES）
- **Bluesky 投稿**: 選択した動画の自動投稿（Rich Text Facet による URL リンク化）
- **SQLite DB**: 動画情報管理、投稿済みフラグ管理、バッチ削除機能
- **ロギング（バニラ状態）**: AppLogger, YouTubeLogger による基本的な操作ログ記録
- **ロギング（プラグイン導入時）**: 9つのロガー（AppLogger, PostLogger, PostErrorLogger, NiconicoLogger, YouTubeLogger, AuditLogger, ThumbnailsLogger, GUILogger, TunnelLogger）による詳細なログ記録

#### GUI 機能
- **動画一覧表示**: DB内の動画を Treeview で表示
- **動画選択**: チェックボックスで投稿対象を選択
- **投稿実行**: 選択した動画を Bluesky へ投稿
- **ドライラン**: 投稿をシミュレート（実際には投稿しない）
- **動画削除**: DB からの完全削除（ツールバー・右クリックメニュー対応）
- **統計表示**: 投稿数、投稿予定、未処理などの統計情報を表示
- **プラグイン表示**: 導入プラグイン一覧と有効/無効状態を表示

#### プラグイン機能（装着時）
- **Bluesky 機能拡張プラグイン**: 画像添付、Jinja2テンプレート処理による複雑なカスタマイズ
- **YouTube API 連携プラグイン**: チャンネルID解決、動画詳細取得、API キー管理
- **YouTube ライブ判定プラグイン**: ライブ/アーカイブ判別（YouTube API プラグインに依存）
- **ニコニコ動画プラグイン**: ニコニコ RSS 監視、新着検出（独立スレッド）、OGP取得
- **ロギング拡張プラグイン**: 複数ロガー管理、レベル制御、独立したログファイル

### RSS 方式の制限
- YouTube の通常動画のみ対応（限定公開、非公開動画は対象外）
- 初回取得時は過去 15 本の動画まで（RSS 仕様）
- ライブ配信・アーカイブの判別不可（YouTube ライブ判定プラグイン で対応可能）

### 実装予定の機能

| 拡張対象 | 内容 |
|---------|------|
| **Web UI** | Tkinter に加えて Web ブラウザ UI を追加 |
| **ダークモード** | GUI のテーマ切り替え機能 |
| **Twitch 連携プラグイン** | Twitch 配信開始・終了検知・通知 |
| **トンネル連携プラグイン** | Cloudflare/ngrok/localtunnel サポート |
| **PubSubHubbub 連携** | リアルタイム通知対応 |
| **データベース拡張** | PostgreSQL/MySQL サポート |

***

## 6. 参考資料

- [YouTube RSS フィード](https://www.newskeeper.io/tools/youtube-rss)
- [Bluesky API ドキュメント](https://docs.bsky.app/blog/create-post)
- [Python feedparser ライブラリ](https://pypi.org/project/feedparser/)
- [atproto ライブラリ](https://github.com/bluesky-social/atproto)