# テンプレート機能の使い方ガイド

**対象バージョン**: v2.1.0 以降
**最終更新**: 2025-12-17

---

## 📖 はじめに

このガイドは、**Streamnotify on Bluesky** の「テンプレート機能」を使う**一般ユーザー向け**のドキュメントです。

### テンプレート機能とは

テンプレート機能は、**Bluesky に投稿される本文を自由にカスタマイズできる機能**です。

通常は、新着動画情報が自動的に同じ形式で投稿されますが、テンプレート機能を使うことで：

- 📝 **好みの文体に変更できます**（堅い文体 → カジュアル、または反対）
- 🎨 **絵文字やハッシュタグを追加できます**
- ⚙️ **表示される情報を調整できます**（タイトルだけ表示、URL を表示 など）
- 🔄 **複数のプラットフォームごとに異なるテンプレートを用意できます**

---

## 📚 対応しているテンプレート種別

現在、以下のプラットフォーム・イベントに対応しています：

| プラットフォーム | イベント | テンプレート名 | 対応状況 | ファイル |
|:--|:--|:--|:--:|:--|
| YouTube | 新着動画投稿 | YouTube 新着動画 | ✅ v2.1.0 | `yt_new_video_template.txt` |
| YouTube | 配信開始（※） | YouTube Live 開始 | 🔜 将来実装 | `yt_online_template.txt` |
| YouTube | 配信終了（※） | YouTube Live 終了 | 🔜 将来実装 | `yt_offline_template.txt` |
| ニコニコ | 新着動画投稿 | ニコニコ 新着動画 | ✅ v2.1.0 | `nico_new_video_template.txt` |
| Twitch | 配信開始（※） | Twitch 配信開始 | 🔜 将来実装 | `twitch_online_template.txt` |

**✅** = 現在利用可能 | **🔜** = 今後実装予定 | **※** = 対応機能そのものが開発中

---

## 📁 テンプレートファイルの場所

テンプレートファイルは、アプリケーションフォルダの以下の場所に保存されます：

```
Streamnotify_on_Bluesky/v2/
├── templates/
│   ├── youtube/                          # YouTube 用テンプレート
│   │   ├── yt_new_video_template.txt     ← 新着動画投稿用
│   │   ├── yt_online_template.txt        ← 配信開始用（将来）
│   │   └── yt_offline_template.txt       ← 配信終了用（将来）
│   │
│   ├── niconico/                         # ニコニコ用テンプレート
│   │   └── nico_new_video_template.txt   ← 新着動画投稿用
│   │
│   └── .templates/                       # デフォルト・フォールバック用
│       └── default_template.txt          ← エラー時の代替テンプレート
│
└── settings.env                          # テンプレート設定
```

### Vanilla（非 Bluesky 投稿）環境について

Vanilla 環境では **Bluesky プラグイン機能が有効になっていません**が、テンプレートファイル自体の構成は変わりません。プラグインを有効にすれば、そのままテンプレート機能が利用可能になります。

---

## ✏️ テンプレートの編集方法

テンプレートを編集する方法は、大きく分けて 2 つあります：

### 📝 方法 1: テキストエディタで直接編集

最もシンプルな方法です。

**手順:**

1. アプリケーションフォルダを開く
2. `v2/templates/` に移動
3. 編集したいテンプレートファイル（例: `youtube/yt_new_video_template.txt`）をテキストエディタで開く
   - Windows: メモ帳、Visual Studio Code、NotePad++ など
   - Mac/Linux: vim, nano, Visual Studio Code など
4. テキストを編集
5. 保存して閉じる

**例:**

変更前:
```
🎬 YouTube に新着動画投稿！
タイトル: {{ title }}
視聴URL: {{ video_url }}
チェックお願いします！👍
```

変更後:
```
新作アップロード🎉

【 {{ title }} 】

{{ video_url }}

#新着 #YouTube
```

### 🖱️ 方法 2: GUI で編集ダイアログを使う（推奨）

アプリケーション内から GUI を使って編集できます。この方法は、**リアルタイムプレビュー**を見ながら編集できるので便利です。

**手順:**

1. アプリケーションを起動
2. 設定画面 → **テンプレート設定** タブを開く（実装予定）
3. 編集したいプラットフォーム / イベントを選択
4. **テンプレート編集ボタン** をクリック
5. 編集ダイアログが開く
6. テンプレートテキストを編集
7. **プレビュー** セクションで投稿イメージを確認
8. 問題なければ **保存** ボタンをクリック

**GUI の特徴:**

- 📝 **テンプレートテキスト エディタ**
  - テンプレートコードを入力します
  - Courier New フォント使用

- 🔘 **テンプレート引数ボタン群**
  - `{{ 変数名 }}`を自動挿入できます
  - 例: **「動画タイトル」** ボタンを押す → `{{ title }}` が挿入される

- 👁️ **ライブプレビュー**
  - 編集中のテンプレートが、実際のサンプルデータでレンダリングされます
  - タイプミスやエラーがあれば、ここで発見できます
  - **プレビュー更新** ボタンで手動更新も可能

- ✅ **保存 / キャンセルボタン**
  - **保存**: テンプレートファイルに書き込まれます
  - **キャンセル**: 変更を破棄して閉じます

---

## 🧮 使える変数の確認方法

各テンプレートで使える変数は、テンプレート種別によって異なります。

### 公式ドキュメントで確認する

詳しい変数一覧は、別ファイル [`v2/docs/TEMPLATE_SPECIFICATION_v2.md`](./TEMPLATE_SPECIFICATION_v2.md) に記載されています。

そこには以下の情報が書かれています：

- 各テンプレートで使える **全変数の一覧**
- 各変数の **説明と型**（文字列、数値 など）
- 各変数の **利用例**
- **必須変数**（必ず含める必要がある変数）
- **高度な使い方**（条件分岐、ループ など）

---

## 📌 具体例: YouTube 新着動画テンプレート

ここでは、**最も使われる「YouTube 新着動画」テンプレート**の具体例を示します。

### 利用可能な変数一覧

YouTube 新着動画テンプレートで使える変数：

| 変数名 | 説明 | 例 |
|:--|:--|:--|
| `{{ title }}` | 動画のタイトル | `"新作ゲーム実況【part 1】"` |
| `{{ video_id }}` | 動画の ID | `"dQw4w9WgXcQ"` |
| `{{ video_url }}` | 動画を見るための URL | `"https://www.youtube.com/watch?v=dQw4w9WgXcQ"` |
| `{{ channel_name }}` | チャンネルの名前 | `"〇〇チャンネル"` |
| `{{ published_at }}` | 動画が投稿された日時 | `"2025-12-17T15:30:00Z"` |
| `{{ platform }}` | プラットフォーム名 | `"YouTube"` （常に固定） |

### デフォルトテンプレート（そのまま使える例）

```
🎬 YouTube に新着動画投稿！

タイトル: {{ title }}
視聴URL: {{ video_url }}

チェックお願いします！👍
```

**このテンプレートで投稿される内容**:

```
🎬 YouTube に新着動画投稿！

タイトル: 新作ゲーム実況【part 1】
視聴URL: https://www.youtube.com/watch?v=dQw4w9WgXcQ

チェックお願いします！👍
```

### カスタマイズ例 1: シンプル版

テンプレート:
```
【新作】{{ title }}

{{ video_url }}

#YouTube #新着動画
```

投稿結果:
```
【新作】新作ゲーム実況【part 1】

https://www.youtube.com/watch?v=dQw4w9WgXcQ

#YouTube #新着動画
```

### カスタマイズ例 2: 詳細版（プレビュー付き）

テンプレート:
```
🎥 新着動画のお知らせ

投稿者: {{ channel_name }}
【 {{ title }} 】

視聴: {{ video_url }}

投稿日時: {{ published_at | datetimeformat('%Y年%m月%d日 %H:%M') }}

#動画投稿
```

投稿結果:
```
🎥 新着動画のお知らせ

投稿者: 〇〇チャンネル
【 新作ゲーム実況【part 1】 】

視聴: https://www.youtube.com/watch?v=dQw4w9WgXcQ

投稿日時: 2025年12月17日 15:30

#動画投稿
```

### カスタマイズ例 3: 条件分岐を使う（高度な使い方）

"ゲーム" という文字がタイトルに含まれていたら、ゲーム配信タグを付ける：

テンプレート:
```
{{ title }}

{{ video_url }}

{% if "ゲーム" in title %}
🎮 ゲーム配信です
{% endif %}

#YouTube
```

投稿結果（ゲームを含む場合）:
```
新作ゲーム実況【part 1】

https://www.youtube.com/watch?v=dQw4w9WgXcQ

🎮 ゲーム配信です

#YouTube
```

投稿結果（ゲームを含まない場合）:
```
【雑談配信】今日の日記

https://www.youtube.com/watch?v=example

#YouTube
```

---

## ❓ よくある質問と注意点

### Q1: 存在しない変数名を書いたらどうなるの？

**A:** 存在しない変数は**空（何も表示されません）**。エラーで投稿が止まることはありません。

例:
```
テンプレート: {{ title }} by {{ creator_name }}
```

- `{{ title }}` → 正しい変数なので「新作ゲーム実況【part 1】」と表示
- `{{ creator_name }}` → 存在しないので、そこは空になる

投稿結果:
```
新作ゲーム実況【part 1】 by
```

**💡 ヒント**: 存在しない変数を使ったかもしれない時は、テンプレート編集ダイアログのプレビューで確認すれば、すぐにわかります。

### Q2: テンプレート編集ダイアログのプレビューで「エラー」と表示される

**A:** テンプレートの**構文にエラーがあります**。よくある例：

- ❌ `{{ title }` （波括弧が 1 つ足りない）
- ❌ `{% if %}` （条件を書いていない）
- ❌ `{{ title | unknown_filter }}` （存在しないフィルター）

プレビュー欄に詳しいエラーメッセージが表示されるので、それに従って修正してください。

### Q3: 必須変数を削除したらどうなるの？

**A:** 必須変数がない場合、投稿がスキップされることがあります。

**必須変数** = 投稿に最低限必要な情報：

- `youtube_new_video`: `title`, `video_id`, `video_url`, `channel_name`（4 つ）
- `nico_new_video`: `title`, `video_id`, `video_url`, `channel_name`（4 つ）

例えば、YouTube 新着動画テンプレートから `{{ video_url }}` を削除してしまうと：

テンプレート:
```
{{ title }}

【削除してしまった！】

#YouTube
```

→ **必須変数 `video_url` が見つからないため、投稿がスキップされます**

**💡 ヒント**: GUI の「テンプレート引数ボタン」には、**必須変数が含まれています**。必須変数がわからなくなったら、ボタンを見てください。

### Q4: Bluesky 投稿機能が無効な場合、テンプレートは機能するの？

**A:** **いいえ、Bluesky プラグインが無効な場合、テンプレートは使われません**。

詳しくは、`settings.env` の `BLUESKY_POST_ENABLED` 設定を確認してください：

- `BLUESKY_POST_ENABLED=True` → テンプレートが使われます
- `BLUESKY_POST_ENABLED=False` → テンプレートは無視されます

### Q5: テンプレートをリセット（初期状態に戻す）したい

**A:** `v2/templates/.templates/default_template.txt` にデフォルトテンプレートが保存されています。

手順:

1. テンプレートファイルをテキストエディタで開く（例: `youtube/yt_new_video_template.txt`）
2. 内容をすべて削除
3. `default_template.txt` の内容をコピーして貼り付け
4. 保存

または、ファイルをバックアップから復元してください。

---

## 🔧 テンプレート機能の設定（settings.env）

テンプレート機能の動作は、`settings.env` ファイルで設定できます。

### テンプレートパス設定（自動検出）

以下の環境変数で、各テンプレートの保存先を指定できます（通常は不要）：

```env
# YouTube テンプレート
TEMPLATE_YOUTUBE_NEW_VIDEO_PATH=templates/youtube/yt_new_video_template.txt

# ニコニコ テンプレート
TEMPLATE_NICO_NEW_VIDEO_PATH=templates/niconico/nico_new_video_template.txt
```

**💡**: 指定しない場合、自動的にデフォルトパスが使われます。

---

## 📞 トラブルシューティング

### テンプレートが反映されていない

**原因と対策:**

1. ✅ Bluesky 投稿が有効になっているか確認
   - `settings.env` で `BLUESKY_POST_ENABLED=True` か確認

2. ✅ テンプレートファイルが保存されているか確認
   - ファイル内容が実際に書き込まれているか確認

3. ✅ アプリケーションを再起動
   - テンプレートの変更は、アプリケーション再起動後に反映されることがあります

### プレビューで「ファイルが見つかりません」と表示される

**原因**: テンプレートファイルが削除されたか、パスが間違っています。

**対策**:

1. テンプレートファイルが存在するか確認
   - `v2/templates/youtube/yt_new_video_template.txt` など
2. ファイル名やパスに間違いがないか確認
3. ファイルが見つからない場合、`default_template.txt` からコピーして復元

### 「テンプレート構文エラー」と表示される

**原因**: Jinja2 形式のエラーがあります。

**よくあるミス:**

- `{{ title }` → ❌（波括弧が 1 つ足りない）
- `{{ title` → ❌（波括弧が全くない）
- `{% if title %}` → ❌（条件を書いていない / 正しい形式：`{% if "string" in title %}` など）

**対策**: プレビュー欄のエラーメッセージをよく読んで、その行を修正してください。

---

## 📚 さらに詳しく学ぶ

さらに高度な使い方（条件分岐、ループ、フィルター など）を学びたい場合は、以下のドキュメントをご覧ください：

- **[v2/docs/TEMPLATE_SPECIFICATION_v2.md](./TEMPLATE_SPECIFICATION_v2.md)** - テンプレート仕様書（詳細版）
- **[Jinja2 公式ドキュメント](https://jinja.palletsprojects.com/)** - Jinja2 の全機能

---

**最終更新**: 2025-12-17
**バージョン**: v2.1.0
**ステータス**: 最新
