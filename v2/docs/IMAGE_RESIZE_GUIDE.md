# 画像自動リサイズ機能（v2.1.0+）

## 概要

Bluesky投稿プラグインに、画像の自動リサイズ・最適化機能を追加しました。
画像投稿が有効な場合、**すべての画像ファイルがこの処理を経由します**。

---

## 処理フロー

```
┌─────────────────────────────────────────┐
│  1. 元画像情報を取得                      │
│    - 解像度（幅×高さ）                   │
│    - フォーマット（JPEG/PNG等）          │
│    - ファイルサイズ                      │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  2. アスペクト比判定＆リサイズ処理        │
│    - 横長（≥1.3）→ 3:2トリミング        │
│    - 正方形/やや横長（0.8-1.3）→ 長辺基準│
│    - 縦長（<0.8）→ 長辺基準              │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  3. JPEG出力（品質90）                  │
│    - アルファチャネル → 白背景で合成    │
│    - ファイルサイズチェック             │
└─────────────────┬───────────────────────┘
                  │
                  ▼
         ┌────────────────┐
         │ 900KB超過？     │
         └────────┬───┬──┘
              No │   │ Yes
          ┌──────┘   └────────┐
          │                   ▼
          │     ┌──────────────────────────┐
          │     │  4. 品質低下で再圧縮      │
          │     │ 90→85→75→65→55→50     │
          │     │ (各段階で1MB確認)        │
          │     └──────────┬───────────────┘
          │                │
          ▼                ▼
   ┌────────────┐   ┌────────────┐
   │ OK, アップロード │  1MB超過   │
   │   (ロギング) │  画像スキップ │
   └────────────┘   └────────────┘
```

---

## 設定・定数

[bluesky_plugin.py](../plugins/bluesky_plugin.py) の先頭に定義されています：

```python
# 画像リサイズ設定（定数）
IMAGE_RESIZE_TARGET_WIDTH = 1280      # 横長画像のターゲット幅
IMAGE_RESIZE_TARGET_HEIGHT = 800      # 横長画像のターゲット高さ（3:2）
IMAGE_OUTPUT_QUALITY_INITIAL = 90     # 初期JPEG品質
IMAGE_SIZE_TARGET = 800_000           # 目標ファイルサイズ（800KB）
IMAGE_SIZE_THRESHOLD = 900_000        # 品質低下の開始閾値（900KB）
IMAGE_SIZE_LIMIT = 1_000_000          # 最終上限（1MB）
```

### 定数の意味

| 定数 | 値 | 説明 |
|------|-----|------|
| `IMAGE_RESIZE_TARGET_*` | 1280×800 | 横長画像を3:2に統一 |
| `IMAGE_OUTPUT_QUALITY_INITIAL` | 90 | JPEG品質は最高品質から |
| `IMAGE_SIZE_TARGET` | 800KB | 理想的なファイルサイズ |
| `IMAGE_SIZE_THRESHOLD` | 900KB | この値を超えたら品質低下 |
| `IMAGE_SIZE_LIMIT` | 1MB | Bluesky API上限 |

---

## 処理パターン詳細

### パターン1: 横長画像（幅/高さ ≥ 1.3）

例：1920×1440（アスペクト比 1.33）

```
元画像: 1920×1440
     ↓
短辺=1440 を基準に 800×600 にスケール
     ↓
1024×800（幅が目標より大きい）
     ↓
中央トリミングで 1280×800 に統一
```

**メソッド**: `_resize_to_aspect_ratio()`
- 短辺を基準に縮小
- 目標アスペクト比（1280÷800=1.6）に寄せる
- 中央トリミング（上下左右均等）

---

### パターン2: 正方形～やや横長（0.8 ≤ 幅/高さ < 1.3）

例：1600×1600（正方形）、1280×1000（やや横長）

```
元画像: 1600×1600
     ↓
長辺=1600 なので 1280×1280 に縮小のみ（アスペクト比維持）
```

**メソッド**: `_resize_to_max_dimension()`
- 長辺が1280以下になるまで等比縮小
- アスペクト比は変わらない
- **小さい画像は拡大しない**

---

### パターン3: 縦長画像（幅/高さ < 0.8）

例：800×1600（縦長）

```
元画像: 800×1600
     ↓
長辺=1600 なので 640×1280 に縮小のみ
```

パターン2と同じ処理（長辺基準）

---

## ファイルサイズ管理

### 目標サイズ: 800KB

- JPEG品質90で出力
- 多くの画像はこれで 500-700KB 程度

### 再圧縮開始: 900KB超過時

品質を段階的に低下:

| 段階 | 品質 | 説明 |
|------|------|------|
| 1 | 90 | 初期出力 |
| 2 | 85 | 再圧縮開始 |
| 3 | 75 | さらに低下 |
| 4 | 65 | さらに低下 |
| 5 | 55 | さらに低下 |
| 6 | 50 | 最後の試み |

**各段階で1MB以下に収まったら成功**

### 最終上限: 1,000,000バイト

1MBを超えた場合は **その投稿では画像添付をスキップ**

```
画像リサイズ失敗
  → _upload_blob() は None を返す
  → post_video() で embed = None
  → リンクカード（URL）のみで投稿
```

---

## ログ出力例

### 成功パターン

```
DEBUG   📏 元画像: 1920×1440 (JPEG, 2150.5KB, アスペクト比: 1.33)
DEBUG   🔄 パターン1（横長）: 3:2（1280×800）に寄せて縮小+中央トリミング
DEBUG      リサイズ後: 1280×800
DEBUG      JPEG品質90: 320.2KB
INFO    ✅ 画像リサイズ完了: 1920×1440 (2150.5KB) → 1280×800 (320.2KB)
```

### 品質低下パターン

```
DEBUG   📏 元画像: 1600×1200 (PNG, 5000.0KB, アスペクト比: 1.33)
DEBUG   🔄 パターン1（横長）: 3:2（1280×800）に寄せて縮小+中央トリミング
DEBUG      リサイズ後: 1280×800
DEBUG      JPEG品質90: 950.5KB
INFO    ⚠️  ファイルサイズが 900KB を超過: 950.5KB
DEBUG      JPEG品質85: 850.2KB
INFO    ✅ 品質85で 1MB 以下に圧縮: 850.2KB
```

### スキップパターン

```
DEBUG   📏 元画像: 8000×6000 (RAW, 150MB, アスペクト比: 1.33)
ERROR   ❌ ファイルサイズの最適化に失敗しました（1MB超過）
WARNING ⚠️  画像リサイズ失敗のため、この投稿では画像添付をスキップします
```

このとき、`embed = None` となり、テキスト＋URLリンクカードで投稿

---

## 実装メソッド

### `_resize_image(file_path: str) -> bytes | None`

**公開インターフェース**（`_upload_blob()` から呼ばれる）

1. 元画像情報を取得
2. アスペクト比判定
3. 3パターンでリサイズ
4. JPEG出力（品質90）
5. ファイルサイズチェック・品質調整
6. ログ出力

**戻り値**:
- 成功: JPEG バイナリ（bytes）
- 失敗: None

### `_resize_to_aspect_ratio(img, target_width, target_height)`

短辺を基準に縮小＋中央トリミング

```python
# 使用例
resized = self._resize_to_aspect_ratio(img, 1280, 800)
```

### `_resize_to_max_dimension(img, max_dimension: int)`

長辺を基準に等比縮小（拡大なし）

```python
# 使用例
resized = self._resize_to_max_dimension(img, 1280)
```

### `_encode_jpeg(img, quality: int) -> bytes`

PIL Image を JPEG でエンコード

```python
# 使用例
jpeg_binary = self._encode_jpeg(img, quality=90)
```

### `_optimize_image_quality(img, current_size_bytes: int) -> bytes | None`

品質を段階的に下げて圧縮（最終的に1MB以下を目指す）

```python
# 使用例
optimized_jpeg = self._optimize_image_quality(img, 950_000)
```

---

## _upload_blob() の変更

従来:
```python
with open(file_path, 'rb') as f:
    image_data = f.read()

if len(image_data) > 1_000_000:
    return None  # エラー
```

新しい（v2.1.0+）:
```python
image_data = self._resize_image(file_path)  # ← リサイズ処理を呼び出し
if image_data is None:
    return None  # リサイズ失敗 → スキップ
```

**つまり、画像添付を有効にしている場合、必ずこの処理を経由します**

---

## 使用している依存ライブラリ

- **Pillow** （PIL）
  - 画像の読み込み・リサイズ・エンコード
  - `requirements.txt` に既に含まれている

---

## 設定の変更方法

### ターゲット解像度を変更したい場合

[bluesky_plugin.py](../plugins/bluesky_plugin.py#L33-L34) の定数を変更:

```python
# 例: 1920×1080 に変更
IMAGE_RESIZE_TARGET_WIDTH = 1920
IMAGE_RESIZE_TARGET_HEIGHT = 1080
```

### 品質段階を変更したい場合

[bluesky_plugin.py](../plugins/bluesky_plugin.py#L446) の `quality_levels` を変更:

```python
# 現在
quality_levels = [85, 75, 65, 55, 50]

# 例: より積極的に落とす
quality_levels = [80, 70, 60, 50]

# 例: より慎重に落とす
quality_levels = [88, 86, 84, 82, 80, 75, 70]
```

### サイズ上限を変更したい場合

```python
# 例: 2MB まで許可
IMAGE_SIZE_LIMIT = 2_000_000
IMAGE_SIZE_THRESHOLD = 1_800_000  # 品質低下の開始値も上げる
```

---

## トラブルシューティング

### Q: 画像が「スキップ」され続ける

**A:** ログで以下を確認:

1. `📏 元画像:` で元のサイズを確認
2. `品質50でも 1MB 超過` が出ていないか
3. 出ている場合は、`IMAGE_SIZE_LIMIT` をまず上げて試す

### Q: 品質が落ちている気がする

**A:**

1. ログで `JPEG品質XX:` の値を確認
2. 品質90で900KB以下なら品質低下は起きていない
3. 品質85以下なら、元画像が大きすぎる可能性

### Q: 小さい画像が拡大される

**A:** 拡大は **しません**

- パターン2・3（正方形/縦長）で、元画像が1280px以下なら拡大しない
- 必要ならパターン1（横長）でも拡大を避けたいなら、コード修正が必要

---

## 参考

- [Pillow ドキュメント](https://pillow.readthedocs.io/)
- [Bluesky Upload Blob API](https://docs.bsky.app/docs/api/com-atproto-repo-upload-blob)
- `IMAGE_RESIZE_GUIDE.md` と連携した投稿テスト手順は [TESTING.md](./TESTING.md) を参照
