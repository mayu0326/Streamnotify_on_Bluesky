# YouTube → Bluesky Notifier v1 設計仕様書

本ドキュメントは、**YouTube新着動画自動投稿ボット v1** の実装仕様書です。

> **注記**: 本ドキュメントは、プラグイン未導入のバニラ状態での正常動作を記述しています。  
> 将来的なプラグイン全盛時の完全版仕様は、別途「将来構想ドキュメント」を参照してください。

***

## 1. 対象サービスと検知方法

### v1 で対応するサービス

- **YouTube**
  - 新着動画投稿のみ対応（RSS方式）
  - RSS フィードから通常動画を自動検知

### v1 で未対応のサービス

- Twitch（サイト連携プラグイン対応）
- ニコニコ動画/生放送（サイト連携プラグイン対応）
- YouTube Live 配信開始・終了検知（YouTube API連携プラグイン対応）

### データ取得方式

- **RSS ポーリング方式（推奨）**
  - YouTube チャンネルの RSS フィードを定期的に取得
  - `POLL_INTERVAL_MINUTES` で指定した間隔（最小 5 分）でポーリング
  - シンプルで安定した方式、追加設定不要

- **YouTube Data API（YouTube API連携プラグイン対応）**
  - 詳細情報取得やライブ配信判別などで活用予定
  - プラグイン導入時のみ有効化可能
  - 動画詳細情報の取得やUC以外のチャンネルIDの監視が可能
  - v1 では RSS フィード取得がデフォルト

***

## 2. 通知先と投稿仕様

### v1 で対応する通知先

- **Bluesky（唯一の通知先）**
  - atproto ライブラリを利用した公式 API 連携
  - YouTube 新着動画の情報を自動投稿

### Bluesky 投稿仕様

- **投稿テンプレート**
  - 投稿内容は固定、画像添付不可
  - Jinja2 形式のテンプレート処理に対応

- **投稿制御**
  - `BLUESKY_POST_ENABLED` で投稿機能を有効/無効化

- **投稿履歴**
  - 投稿結果を CSV 形式で記録（`logs/post_history.csv`）
  - 投稿日時、動画 ID、タイトル、URL、投稿結果を記録

### v1 で未対応

- Discord 連携（通知拡張プラグイン対応）
- 画像添付機能（機能拡張プラグイン対応）
- カスタム投稿テンプレート（機能拡張プラグイン対応）

***

## 3. 利用・運用要件

### 必要環境

- **ハードウェア・ネットワーク**
  - インターネット回線（ポーリングで RSS 取得のため）
  - PC または Linux マシン（常時起動不要、定期実行可能）
  - ドメイン・固定 IP は不要

- **ソフトウェア**
  - Python 3.10 以上
  - Git（リポジトリ clone 用、オプション）

### セットアップの簡潔性

- **設定方法**
  - `settings.env.example` をコピーして `.env` を作成
  - テキストエディタで 4 つの必須項目（YouTube チャンネル ID、Bluesky 認証情報、ポーリング間隔）を編集
  - `python main_v1.py` で起動

- **外部サービス連携**
  - 必須: YouTube チャンネル、Bluesky アカウント

### 操作・UI

- **実行方法**
  - コマンドラインから `python main_v1.py` で起動
  - 手動動画通知・再通知用の最小限機能版GUIは実装済み。
  - ターミナル出力でログ確認
  - `Ctrl + C` で安全終了

- **設定変更**
  - 手動で `.env` を編集
  - 変更後、アプリを再起動して反映

### v1 で未対応

- 設定GUI / Web UI（機能拡張プラグイン対応）
- トンネルサービス連携(Cloudflare/ngrok/localtunnel)（トンネル連携プラグイン対応）
- 自動インストール機能（Python/Git の事前インストールが必須）

***

## 4. 内部アーキテクチャ

### コア構成

- **設定レイヤー（config.py）**
  - `.env` ファイルから設定値を読み込み
  - ポーリング間隔（5 分以上）などのバリデーション実施

- **データ取得レイヤー（youtube_rss.py）**
  - YouTube チャンネル ID から RSS URL を生成
  - RSS フィードを定期的にポーリング
  - 新着動画情報（動画 ID、タイトル、公開日時）を抽出

- **ストレージレイヤー（database.py）**
  - SQLite データベース（`data/youtube_notify.db`）で動画情報を管理
  - 既取得動画の重複判定（`video_id` のユニーク制約）
  - 投稿済みフラグ（`posted_to_bluesky`）で投稿状態を管理

- **通知レイヤー（bluesky_plugin.py → bluesky_v1.py）**
  - DB の未投稿動画をテンプレート処理で Bluesky 投稿形式に変換
  - atproto ライブラリで Bluesky API に投稿
  - 投稿完了後、投稿済みフラグを更新

- **メインループ（main_v1.py）**
  - 設定読み込み → DB 初期化 → 無限ループで以下を繰り返:
    1. RSS フィード取得
    2. 新着動画を DB に保存
    3. 未投稿動画を取得
    4. 投稿制御フラグが有効な場合のみ Bluesky に投稿
    5. ポーリング間隔分スリープ

### 技術スタック

- **言語**: Python 3.10+
- **フレームワーク**: 標準ライブラリのみ（sqlite3）
- **外部ライブラリ**: 
  - `feedparser` - RSS パース
  - `atproto` - Bluesky API
  - `requests` - HTTP リクエスト
  - `jinja2` - テンプレート処理
  - `python-dotenv` - 環境変数管理
  - `pytz`, `tzlocal` - タイムゾーン処理

- **ストレージ**: SQLite（`data/youtube_notify.db`）+ CSV ログ（`logs/post_history.csv`）  

***

## 5. v1 の制限事項と将来の拡張

### v1 で制限されている機能

#### RSS 方式の制限
- YouTube の通常動画のみ対応（限定公開、非公開動画は対象外）
- 初回取得時は過去 10 本の動画まで（RSS 仕様）
- ライブ配信・アーカイブの判別不可

#### 監視対象の制限
- YouTube チャンネル 1 件のみ（複数チャンネル対応は YouTube API連携プラグイン対応）
- UC から始まるチャンネル ID のみ（カスタム URL は YouTube API連携プラグイン対応）

#### 通知機能の制限
- Bluesky のみ（Discord 連携は通知拡張プラグイン対応）
- 投稿への画像添付は未対応（機能拡張プラグイン対応）

#### インターフェースの制限
- CLI のみ（`python main_v1.py` で起動）
- 最小限機能の手動動画通知GUIは実装済み
- 設定GUI / Web UI は未対応（機能拡張プラグイン対応）

#### デプロイ・運用の制限
- Docker コンテナ化未対応（機能拡張プラグイン対応）
- トンネル連携未対応（PubSubHubbub プラグイン対応）

### 将来の拡張計画

| 拡張対象 | v2以降での実装予定 |
|---------|------------------|
| **サイト連携プラグイン** | Twitch、ニコニコ動画/生放送対応 |
| **YouTube API連携プラグイン** | ライブ配信判別、動画詳細取得、カスタムID対応 |
| **通知拡張プラグイン** | Discord 連携、LINE 連携（検討中） |
| **機能拡張プラグイン** | 画像添付、GUI/Web UI、ダークモード、詳細ログ設定 |
| **PubSubHubbub プラグイン** | リアルタイム通知、トンネルサービス連携 |
| **トンネル連携プラグイン** | トンネルサービス連携 |
| **データベース連携プラグイン** | SQLite以外のデータベース連携 |

### プラグインアーキテクチャ

v1 から v2 以降への拡張は、プラグイン形式で設計されています:

- **コア機能**: RSS ポーリング、SQLite DB、Bluesky 投稿（v1 で実装）
- **プラグイン**: 上記コアに対する拡張機能（v2 以降で段階的に追加）
- **モジュール化**: 各プラグインは独立して追加/削除可能

***

## 6. 参考資料

- [YouTube RSS フィード](https://www.newskeeper.io/tools/youtube-rss)
- [Bluesky API ドキュメント](https://docs.bsky.app/blog/create-post)
- [Python feedparser ライブラリ](https://pypi.org/project/feedparser/)
- [atproto ライブラリ](https://github.com/bluesky-social/atproto)