# 動作モード完全ガイド

**対象バージョン**: v3.1.0+
**最終更新**: 2025-12-21
**ステータス**: ✅ 実装完了

---

## 📖 このガイドについて

StreamNotify には、利用シーンに応じて **4つの動作モード** があります。

このドキュメントでは、各モードの特徴、使い分け、設定方法を説明します。

**対象**: 中級ユーザー、カスタマイズしたいユーザー向け

---

## 🎯 動作モード一覧

| モード | 説明 | 自動投稿 | RSS取得 | 手動投稿 | 用途 |
|:--|:--|:--:|:--:|:--:|:--|
| **selfpost** | 完全手動投稿 | ✗ | ✓ | ✓ | 投稿内容を確認後に投稿したい |
| **autopost** | 完全自動投稿 | ✓ | ✓ | ✓ | 完全自動化したい |
| **dry_run** | テストモード | ✗ | ✓ | ✓ | 投稿をシミュレート（実投稿なし） |
| **collect** | 収集モード | ✗ | ✓ | ✗ | RSS取得とDB保存のみ |

---

## 🔴 モード 1: SELFPOST（推奨・デフォルト）

### 概要

```
RSS取得 → DB保存 → 【ユーザーが GUI で確認】 → 手動投稿 → Bluesky投稿
```

**最も安全で、投稿内容を確認してから投稿できるモード**です。

### 設定方法

```env
# settings.env に以下を設定
APP_MODE=selfpost
```

### 特徴

| 特性 | 説明 |
|:--|:--|
| **RSS自動取得** | ✅ POLL_INTERVAL_MINUTES ごとに自動取得 |
| **DB自動保存** | ✅ 新着動画を自動保存 |
| **投稿** | 🔧 GUI で動画を選択して手動投稿 |
| **投稿対象判定** | 🔧 ユーザーが GUI フィルタで指定 |
| **リスク** | ✅ 最小（投稿前に確認可能） |

### 使用シーン

1. **💼 安心運用したい**
   - 投稿内容を必ず確認したい
   - 誤投稿を防ぎたい

2. **🎨 投稿内容をカスタマイズしたい**
   - 手動でテンプレートを選択
   - 画像を差し替えたい

3. **🔍 動画一覧を監視したい**
   - 新着動画が全て表示される
   - 重複動画を検知できる

### 操作フロー

```
1. アプリ起動
   → settings.env で APP_MODE=selfpost 確認
   → GUI が表示される

2. 新着動画が取得される
   → GUI の「動画一覧」に表示
   → RSS取得時刻に更新

3. 投稿対象を選択
   → 左側の チェックボックスをON
   → または フィルタで絞り込み

4. 投稿実行
   → [投稿実行] ボタンをクリック
   → Bluesky に投稿
   → DB が「投稿済み」に更新

5. ログで確認
   → ログウィンドウで ✅ を確認
```

### GUI の操作画面

```
┌─ StreamNotify on Bluesky v3.1.0 ──────────────────┐
│                                                    │
│ ★ 動作モード: SELFPOST（手動投稿）                 │
│ ★ RSS ポーリング: 10 分ごと                        │
│ ★ 最終更新: 2025-12-21 14:30                      │
│                                                    │
├─ フィルタ ──────────────────────────────────────┤
│ [検索キーワード]                [リセット]        │
│ ◇ 投稿状態: [全て] ◇ 配信元: [全て]              │
│                                                    │
├─ 動画一覧 ──────────────────────────────────────┤
│ ☑ 【新着】新作動画発表！       未投稿  YouTube  │
│ ☐ 【Shorts】30秒動画          未投稿  YouTube  │
│ ☐ ライブ配信予定             未投稿  YouTube  │
│                                                    │
├─ 操作パネル ──────────────────────────────────────┤
│ [投稿実行] [投稿テスト] [削除] [更新] [終了]      │
│                                                    │
├─ ログウィンドウ ──────────────────────────────────┤
│ ✅ 2025-12-21 14:30: 動画 1 件を投稿しました     │
│ ℹ️ 次の RSS 取得: 14:40                          │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## 🟡 モード 2: AUTOPOST（完全自動）

### 概要

```
RSS取得 → DB保存 → 【自動判定】 → 自動投稿 → Bluesky投稿
```

**設定と環境変数のみで、完全に自動投稿するモード**です。

⚠️ **注意**: 投稿内容の確認なしに自動投稿されます。慎重に設定してください。

### 設定方法

```env
# settings.env に以下を設定
APP_MODE=autopost

# AUTOPOST 制御パラメータ（デフォルトのままでOK）
AUTOPOST_INTERVAL_MINUTES=5           # 最小投稿間隔
AUTOPOST_LOOKBACK_MINUTES=30          # 安全チェック時間窓
AUTOPOST_UNPOSTED_THRESHOLD=20        # 未投稿動画の安全上限

# 投稿対象フィルタ
AUTOPOST_INCLUDE_NORMAL=true          # 通常動画を投稿
AUTOPOST_INCLUDE_SHORTS=false         # Shorts を投稿
AUTOPOST_INCLUDE_MEMBER_ONLY=false    # メンバー限定を投稿
AUTOPOST_INCLUDE_PREMIERE=true        # プレミア配信を投稿
```

### 特徴

| 特性 | 説明 |
|:--|:--|
| **RSS自動取得** | ✅ POLL_INTERVAL_MINUTES ごとに自動取得 |
| **DB自動保存** | ✅ 新着動画を自動保存 |
| **投稿判定** | ✅ 環境変数に基づき自動判定 |
| **投稿実行** | ✅ 条件を満たせば自動投稿 |
| **GUI** | ✓ 表示されるが操作不要 |
| **リスク** | ⚠️ 高（誤投稿の可能性） |

### AUTOPOST の安全弁機構

**大量誤投稿を防ぐため、3つの安全機構が働きます：**

```
1️⃣ 投稿間隔チェック
   ├─ AUTOPOST_INTERVAL_MINUTES 以上経過していないと投稿しない
   └─ デフォルト: 5分 → 最短 5分ごと投稿

2️⃣ 未投稿動画チェック
   ├─ LOOKBACK 時間内の未投稿動画数が THRESHOLD を超えたら投稿中止
   └─ 異常検知: RSS取得が多すぎる、重複登録が多い → スキップ

3️⃣ 動画種別フィルタ
   ├─ INCLUDE_*** 環境変数で投稿対象を限定
   └─ 例: 通常動画のみ投稿、Shorts は投稿しない
```

### 使用シーン

1. **🤖 完全自動化したい**
   - 24/7 自動で投稿
   - 手動操作が不要

2. **⏰ 定期的な投稿スケジュール**
   - 毎日決まった時間に投稿
   - スケジュール確定後の運用

3. **📊 大量投稿を自動化**
   - YouTube チャンネルの全動画を投稿
   - Bluesky の投稿数を増やしたい

### 自動投稿のフロー

```
【アプリ起動】
   ↓
【RSS 取得（10分ごと）】
   ↓
【DB に未投稿動画が 1件以上あるか】
   ├─ NO → 何もしない
   └─ YES ↓
【前回投稿から INTERVAL_MINUTES 以上経過したか】
   ├─ NO → スキップ（待機中）
   └─ YES ↓
【LOOKBACK 時間内の未投稿数が THRESHOLD以下か】
   ├─ NO → 投稿停止（異常検知）
   └─ YES ↓
【投稿対象フィルタを満たすか】
   ├─ NO → スキップ
   └─ YES ↓
【自動投稿実行】
   ↓
【ログ出力】
```

### 実例: 複雑な設定例

```env
# 【パターン A】慎重型：通常動画のみ、1時間に1回
APP_MODE=autopost
AUTOPOST_INTERVAL_MINUTES=60
AUTOPOST_LOOKBACK_MINUTES=60
AUTOPOST_UNPOSTED_THRESHOLD=10
AUTOPOST_INCLUDE_NORMAL=true
AUTOPOST_INCLUDE_SHORTS=false
AUTOPOST_INCLUDE_MEMBER_ONLY=false
AUTOPOST_INCLUDE_PREMIERE=false

# 【パターン B】積極型：全種別投稿、5分ごと
APP_MODE=autopost
AUTOPOST_INTERVAL_MINUTES=5
AUTOPOST_LOOKBACK_MINUTES=30
AUTOPOST_UNPOSTED_THRESHOLD=20
AUTOPOST_INCLUDE_NORMAL=true
AUTOPOST_INCLUDE_SHORTS=true
AUTOPOST_INCLUDE_MEMBER_ONLY=true
AUTOPOST_INCLUDE_PREMIERE=true
```

---

## 🟠 モード 3: DRY_RUN（テストモード）

### 概要

```
RSS取得 → DB保存 → GUI表示 → 【投稿シミュレーション】 → 実投稿なし
```

**投稿をテストして、実際には投稿しないモード**です。

✅ **推奨**: 初回セットアップやテンプレート調整時に使用

### 設定方法

```env
# settings.env に以下を設定
APP_MODE=dry_run
```

### 特徴

| 特性 | 説明 |
|:--|:--|
| **RSS自動取得** | ✅ POLL_INTERVAL_MINUTES ごとに自動取得 |
| **DB自動保存** | ✅ 新着動画を自動保存 |
| **手動投稿** | ✓ GUI で投稿ボタンをクリック可能 |
| **Bluesky投稿** | ✗ 投稿をシミュレートのみ（実投稿なし） |
| **DB 更新** | ✗ 投稿済みフラグが立たない |
| **用途** | テスト・デバッグ |

### DRY_RUN で何をテストするか

```
1️⃣ 設定ファイルが正しいか
   → 「投稿テスト」ボタンで Bluesky 接続をテスト

2️⃣ RSS 取得が正常か
   → 「動画一覧」に動画が表示されるか確認

3️⃣ テンプレートが正しいか
   → ログに「テンプレートを適用しました」と表示されるか

4️⃣ 画像処理が正常か
   → 画像自動リサイズが成功するか

5️⃣ 複雑なフィルタが機能するか
   → GUI フィルタで正しく動画が絞り込まれるか
```

### 使用シーン

1. **🔧 初回セットアップ時**
   - 設定が正しいか確認
   - RSS 取得が成功しているか確認

2. **🎨 テンプレートをカスタマイズするとき**
   - 新しいテンプレートの動作確認
   - 投稿内容の確認

3. **🐛 バグの発生箇所を特定するとき**
   - ログを詳しく見たい
   - 実投稿を避けたい

### DRY_RUN の操作

```
1. settings.env で APP_MODE=dry_run に設定
2. アプリを起動
3. 動画を選択
4. [投稿テスト] ボタンをクリック
   → ログウィンドウに「🧪 [DRY RUN]」が表示される
   → Bluesky には投稿されない
5. ログで出力内容を確認

【ログ出力例】
🧪 [DRY RUN] テキスト投稿をシミュレートします
📝 本文: 【新着動画】...
📊 テキスト長: 142 文字
📸 画像: thumbnail.jpg (1.2 MB)
🧪 [DRY RUN] 投稿をシミュレート完了（本投稿なし）
```

---

## 🟢 モード 4: COLLECT（収集モード）

### 概要

```
RSS取得 → DB保存 → 【終了】
```

**RSS取得と DB 保存のみを行い、投稿機能は無効にするモード**です。

### 設定方法

```env
# settings.env に以下を設定
APP_MODE=collect
```

### 特徴

| 特性 | 説明 |
|:--|:--|
| **RSS自動取得** | ✅ POLL_INTERVAL_MINUTES ごとに自動取得 |
| **DB自動保存** | ✅ 新着動画を自動保存 |
| **GUI** | ✓ 表示されるが投稿機能は無効 |
| **手動投稿** | ✗ 投稿ボタンが無効化 |
| **Bluesky投稿** | ✗ 無効化 |
| **用途** | データ収集のみ |

### 使用シーン

1. **📊 YouTube の新着動画を自動収集**
   - チャンネルの全動画リストを取得
   - 後で Bluesky に投稿するか判定したい

2. **🔍 DB をバックアップ・移行するとき**
   - 投稿機能を無効化
   - RSS 取得に集中

3. **⏸️ 投稿を一時停止**
   - RSS 取得は続けたい
   - 一時的に投稿を停止

### COLLECT モードの操作

```
1. settings.env で APP_MODE=collect に設定
2. アプリを起動
3. GUI が表示されるが、投稿ボタンは無効化
4. [投稿実行] [投稿テスト] ボタンが灰色
5. RSS 取得は自動的に継続
6. ログで「RSS 取得完了」を確認
```

---

## 📋 モード選択の判断表

以下の質問に答えると、適切なモードが見つかります：

```
【質問1】投稿内容を確認してから投稿したい？

   YES → SELFPOST（デフォルト）
     ※ GUI で選択して手動投稿

   NO ↓

【質問2】完全に自動化したい？

   YES → AUTOPOST
     ※ ただし設定に細心の注意

   NO ↓

【質問3】投稿をテストしたい？

   YES → DRY_RUN
     ※ 実投稿なしでシミュレーション

   NO ↓

【質問4】RSS 取得とデータ収集のみ？

   YES → COLLECT
     ※ 投稿機能なし
```

---

## ⚙️ モード変更時の注意

### モード変更手順

```bash
1. アプリを停止
   → [終了] ボタン または Ctrl+C

2. settings.env を編集
   → テキストエディタで APP_MODE を変更
   → 保存

3. アプリを再起動
   → python main_v3.py

4. ログで「APP_MODE: ****」を確認
```

### DB に対する影響

```
モード変更による DB への影響:

SELFPOST → AUTOPOST
  ✅ 問題なし（DB はそのまま利用）
  ⚠️ 自動投稿が開始されます

AUTOPOST → SELFPOST
  ✅ 問題なし（DB はそのまま利用）
  ✅ 手動操作に戻ります

DRY_RUN → SELFPOST
  ✅ 投稿実行に変わります
  ⚠️ 既に DB に登録された動画が投稿されます

COLLECT → その他のモード
  ✅ 投稿機能が有効になります
  ⚠️ 既に DB に登録された動画が投稿対象になります
```

---

## 🎯 推奨される運用パターン

### パターン A: 安定運用（最も推奨）

```
【初期段階】
1. APP_MODE=collect で 3日間 RSS取得
2. 動画一覧を確認

【セットアップ段階】
3. APP_MODE=dry_run でテンプレート・設定確認
4. [投稿テスト] で Bluesky 接続確認

【本運用】
5. APP_MODE=selfpost で手動投稿開始
6. 毎日 GUI で新着動画を確認して投稿
```

### パターン B: 自動化運用

```
【準備段階】
1. APP_MODE=dry_run で十分にテスト
2. 環境変数を念入りに確認
3. [投稿テスト] で複数回検証

【本運用】
4. APP_MODE=autopost に変更
5. 最初の 3日間は ログを毎日確認
6. 問題なければ自動運用継続
```

---

## 💡 トラブルシューティング

### モード変更後、投稿ボタンが無効

```
原因: 設定を変更したが、アプリを再起動していない
対応: アプリを完全に終了し、再起動
```

### AUTOPOST が実行されない

```
原因: 以下の可能性
1. AUTOPOST_INTERVAL_MINUTES が経過していない
2. DB に未投稿動画がない
3. AUTOPOST_UNPOSTED_THRESHOLD を超えている

対応:
1. ログで投稿間隔を確認
2. GUI で動画一覧を確認
3. 設定値を見直す
```

### DRY_RUN でも投稿されている

```
原因: APP_MODE を保存していない
対応: settings.env で APP_MODE=dry_run を確認して再起動
```

---

**関連ドキュメント**:
- [GETTING_STARTED.md](./GETTING_STARTED.md) - クイックスタート
- [FAQ_TROUBLESHOOTING_BASIC.md](./FAQ_TROUBLESHOOTING_BASIC.md) - よくある質問

**最終更新**: 2025-12-21
