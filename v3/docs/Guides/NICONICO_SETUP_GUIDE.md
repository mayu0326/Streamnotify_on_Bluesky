# ニコニコ動画 セットアップガイド

**対象バージョン**: v3.1.0+
**最終更新**: 2025-12-21
**ステータス**: ✅ 実装完了

---

## 📖 このガイドについて

このドキュメントは、**Streamnotify on Bluesky でニコニコ動画を監視・投稿するための設定ガイド**です。

ニコニコ動画の新着動画を自動検出して Bluesky に投稿できます。

---

## 🎯 ニコニコプラグインの機能

- ✅ **RSS 監視**: 指定ユーザーの新着動画を自動検出
- ✅ **自動投稿**: Bluesky への自動投稿（テンプレート対応）
- ✅ **ユーザー名自動取得**: ユーザーIDからユーザー名を自動取得

---

## 📋 必須情報の準備

### 1️⃣ ニコニコユーザーID を確認

ニコニコユーザーID（数値のみ）を確認します。

**確認方法:**

#### 方法 1: ニコニコ公式サイトから確認（推奨）

1. [ニコニコ公式サイト](https://www.nicovideo.jp/) にアクセス
2. 左上のメニュー → 「**ユーザー**」 をクリック
3. 自分のプロフィールをクリック
4. プロフィール URL を確認：
   ```
   https://www.nicovideo.jp/user/123456789
   ↑↑↑↑↑↑↑↑↑ これがユーザーID
   ```

#### 方法 2: マイページから確認

1. ニコニコ にログイン
2. 右上アイコン → 「マイページ」
3. URL を確認：`https://www.nicovideo.jp/my/top`
4. プロフィール編集 → URL に表示されるIDを確認

**例:**
```
ユーザーID: 123456789
```

---

## ⚙️ settings.env で設定

### 基本設定

テキストエディタで `v3/settings.env` を開き、以下を設定します：

```env
# =============================
# ニコニコ動画プラグイン
# =============================

# 監視対象のニコニコユーザーID（数字のみ）
NICONICO_USER_ID=123456789

# ニコニコのユーザー名（省略可、自動取得試みる）
NICONICO_USER_NAME=

# ニコニコのポーリング間隔（分、最小5分、推奨: 10分）
NICONICO_POLL_INTERVAL=10
```

### 詳細説明

| 設定項目 | 説明 | 例 | 必須 |
|:--|:--|:--|:--:|
| `NICONICO_USER_ID` | ニコニコユーザーID（数値のみ） | `123456789` | ✅ |
| `NICONICO_USER_NAME` | ユーザー名（表示名） | `太郎` | ⭕ |
| `NICONICO_POLL_INTERVAL` | ポーリング間隔（分） | `10` | ⭕ |

#### NICONICO_USER_ID（必須）

- ニコニコユーザーIDは**数字のみ**で指定してください
- プロフィール URL から抽出した数値を入力

**❌ 間違い:**
```env
NICONICO_USER_ID=user123456789  # ユーザー名は含めない
NICONICO_USER_ID=https://nicovideo.jp/user/123456789  # URL は含めない
```

**✅ 正しい:**
```env
NICONICO_USER_ID=123456789  # 数字のみ
```

#### NICONICO_USER_NAME（オプション）

- テンプレートで「投稿者名」として表示されます
- **未設定時は自動取得を試みます**（優先順位: RSS > API > ユーザーID）
- 自動取得に失敗した場合の代替値として設定してください

**使用例:**
```env
NICONICO_USER_NAME=太郎
```

投稿時テンプレートに以下のような形で表示されます：
```
【新着動画】太郎がニコニコ動画をアップロード
タイトル: {title}
視聴URL: {video_url}
```

#### NICONICO_POLL_INTERVAL（推奨: 10分）

- ポーリング間隔を分単位で指定（最小5分）
- 小さいほど反応が早いですが、API負荷が増えます
- **推奨: 10分～30分**

```env
NICONICO_POLL_INTERVAL=10  # 10分ごとに確認
```

---

## 🚀 アプリを起動

すべての設定が完了したら、アプリを起動します：

```bash
# (既に起動している場合は再起動)
python main_v3.py
```

### 起動ログを確認

ターミナルまたはログウィンドウで以下のメッセージが表示されることを確認：

```
✅ ニコニコプラグインをロードしました
📝 ニコニコユーザーID: 123456789
```

---

## ✅ セットアップ動作確認

### 1️⃣ ニコニコ動画が取得されているか確認

```
GUI の「動画一覧」にニコニコ動画が表示されているか？
↓
【YES】→ ✅ 成功
【NO】 → 以下をチェック：
  1. ニコニコユーザーID が正しいか
  2. ユーザーに新着動画があるか
  3. ポーリング間隔内で反映されたか
```

### 2️⃣ テンプレートが正しく適用されているか確認

```
1. ニコニコ動画を選択
2. 「投稿テスト」をクリック
3. ログで以下を確認：
   ✅ テンプレートを使用して本文を生成しました: niconico_new_video
```

### 3️⃣ Bluesky に投稿

```
1. ニコニコ動画を選択
2. 「投稿実行」をクリック
3. Bluesky に投稿が表示される
```

---

## ⚠️ 注意事項・制限事項

### RSS 仕様上の制限

- ✅ **対応**: 新着動画（アップロード済み）
- ❌ **非対応**: ニコニコ生放送・ライブ配信

- ニコニコ生放送を監視したい場合は、プラグイン作成や機能追加が必要です。
- ニコニコ生放送に関する 公式APIの提供がありませんので、今後も対応予定はありません。

### ユーザー名の自動取得

ニコニコの仕様により、以下の場合に自動取得が失敗することがあります：

1. プロフィール非公開設定
2. ユーザーIDから名前が取得できない 場合

この場合、**`NICONICO_USER_NAME` を明示的に設定してください**：

```env
NICONICO_USER_NAME=太郎  # 手動設定
```

### ポーリング間隔の推奨値

| 用途 | 推奨間隔 | 説明 |
|:--|:--|:--|
| リアルタイム性重視 | 5～10分 | API負荷増加、頻繁なポーリング |
| バランス型（推奨） | 10～30分 | 標準的な設定 |
| サーバー負荷軽減 | 30～60分 | 投稿頻度が少ない場合向け |

---

## 🐛 よくある問題と対応

### ❌ 「ニコニコ動画が表示されない」

**原因**: ユーザーID が間違っている、または RSS が無応答

**対応**:

1. ニコニコユーザーID が正しいか再確認
   ```bash
   # URL から確認
   https://www.nicovideo.jp/user/123456789
   ```

2. ユーザーに新着動画があるか確認
   ```
   ニコニコ公式サイト → ユーザーのページ → 動画一覧
   ```

3. ログで詳細を確認
   - ターミナル出力を確認
   - `v3/logs/app.log` を確認

### ❌ 「投稿テストが失敗する」

**原因**: テンプレートファイルが見つからない、または必須変数が不足

**対応**:

1. テンプレートファイルが存在するか確認
   ```
   v3/templates/niconico/nico_new_video_template.txt
   ```

2. テンプレートの必須変数を確認
   - `{{ title }}` - 動画タイトル
   - `{{ video_url }}` - 動画URL
   - `{{ channel_name }}` - ユーザー名

3. ログで詳細メッセージを確認
   ```
   [ERROR] テンプレート処理エラー: ...
   ```

### ❌ 「ユーザー名が表示されない」

**原因**: 自動取得失敗、または プロフィール非公開

**対応**:

1. `NICONICO_USER_NAME` を明示的に設定
   ```env
   NICONICO_USER_NAME=太郎  # 手動指定
   ```

2. ニコニコプロフィールの公開設定を確認
   - ニコニコ設定 → プライバシー → プロフィール公開設定

---

## 📝 テンプレートのカスタマイズ

ニコニコ動画投稿用テンプレートをカスタマイズできます。

### テンプレートファイルの場所

```
v3/templates/niconico/nico_new_video_template.txt
```

### 使える変数

| 変数 | 説明 | 例 |
|:--|:--|:--|
| `{{ title }}` | 動画タイトル | `新作ゲーム実況` |
| `{{ video_url }}` | 動画URL | `https://www.nicovideo.jp/watch/sm12345678` |
| `{{ channel_name }}` | ユーザー名 | `太郎` |
| `{{ published_at }}` | 投稿日時 | `2025-12-21 10:30:00` |
| `{{ video_id }}` | 動画ID | `sm12345678` |

### カスタマイズ例

**変更前:**
```jinja2
【新着動画】{{ channel_name }}がニコニコに投稿！
{{ title }}
{{ video_url }}
#ニコニコ動画
```

**変更後:**
```jinja2
🎬 {{ channel_name }} の新作アップロード

{{ title }}

📺 視聴はこちら
{{ video_url }}

#ニコニコ #ニコニコ動画
```

---

## 🔗 関連ドキュメント

- [GETTING_STARTED.md](./GETTING_STARTED.md) - クイックスタートに戻る
- [SETTINGS_OVERVIEW.md](./SETTINGS_OVERVIEW.md) - 全設定項目一覧
- [TEMPLATE_SYSTEM.md](../Technical/TEMPLATE_SYSTEM.md) - テンプレートシステム詳細
- [FAQ_TROUBLESHOOTING_BASIC.md](./FAQ_TROUBLESHOOTING_BASIC.md) - トラブルシューティング

---

**セットアップが完了したら、[GETTING_STARTED.md](./GETTING_STARTED.md) に戻って次のステップへ進んでください！**

**最終更新**: 2025-12-21
