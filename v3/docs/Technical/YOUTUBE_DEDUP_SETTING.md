# YouTube重複排除設定ガイド

## 概要

`YOUTUBE_DEDUP_ENABLED` 設定により、YouTube 動画の重複排除機能をオン/オフできます。

## 設定方法

### settings.env での設定

```env
# YouTube重複排除オプション（true/false、デフォルト: true）
YOUTUBE_DEDUP_ENABLED=true
```

### 設定値の説明

| 値 | 動作 | 用途 |
|:--|:--|:--|
| **true**（デフォルト） | 同じタイトル+チャンネルの動画は優先度ベースで管理 | 本番運用 |
| **false** | すべての動画が登録される | テスト・デバッグ |

## 有効（true）の場合の動作

同じタイトル + チャンネル名の動画が複数ある場合、優先度に基づいて保持すべき動画を特定します。

### 優先度（高→低）

1. **アーカイブ** (`content_type="archive"`, `live_status="completed"`) - 優先度: 4
2. **ライブ配信** (`content_type="live"`, `live_status="live"` or `"upcoming"`) - 優先度: 3
3. **通常動画** (`content_type="video"`) - 優先度: 1

### 具体例

Webhook API から 4 つのビデオが取得されたとき：

| Video ID | タイトル | 優先度 | 結果 |
|:--|:--|:--|:--|
| `jVB-Pv4IZJo` | 【まゆにゃあ生放送】アプリ実装確認枠 | 4（archive） | ✅ 登録 |
| `UYoKsFZ4OJI` | 【まゆにゃあ生放送】アプリ実装確認枠 | 4（archive） | ⏭️ 排除（同じ優先度） |
| `58S5Pzux9BI` | 【雑談】ゆめうさサイト... | 3（live） | ✅ 登録 |
| `EttkV6rR8ic` | 【まゆにゃあ生放送】アプリ実装確認枠 | 4（archive） | ⏭️ 排除（重複） |

結果: **2 本の動画が DB に登録**

## 無効（false）の場合の動作

すべての動画が登録されます。重複排除チェックはスキップされます。

### 具体例

Webhook API から 4 つのビデオが取得されたとき：

| Video ID | タイトル | 結果 |
|:--|:--|:--|
| `jVB-Pv4IZJo` | 【まゆにゃあ生放送】アプリ実装確認枠 | ✅ 登録 |
| `UYoKsFZ4OJI` | 【まゆにゃあ生放送】アプリ実装確認枠 | ✅ 登録 |
| `58S5Pzux9BI` | 【雑談】ゆめうさサイト... | ✅ 登録 |
| `EttkV6rR8ic` | 【まゆにゃあ生放送】アプリ実装確認枠 | ✅ 登録 |

結果: **4 本の動画すべてが DB に登録**

## 使い分け

### 本番運用（推奨: true）

- 同じコンテンツの重複登録を防止
- Webhook から重複データが来ても自動で管理
- ユーザー体験の向上

### テスト・デバッグ（false）

- すべてのビデオを登録したい場合
- 重複排除ロジックの検証を外したい場合
- 一時的なテストランの際

## 関連設定

### PREVENT_DUPLICATE_POSTS

- **YouTube重複排除** (`YOUTUBE_DEDUP_ENABLED`): Webhook 取得時に同一コンテンツの重複排除
- **重複投稿防止** (`PREVENT_DUPLICATE_POSTS`): 同じ動画の再投稿を防止

**注記**: これら 2 つの設定は独立して動作します。

## ログ出力例

### 有効時（true）

```
🔄 処理中: jVB-Pv4IZJo
  ├─ DB に登録... ✅ 新規
  ...

🔄 処理中: UYoKsFZ4OJI
  ├─ DB に登録... ⏭️ 既存（重複排除）
```

### 無効時（false）

```
🔄 処理中: jVB-Pv4IZJo
  ├─ DB に登録... ✅ 新規
  ...

🔄 処理中: UYoKsFZ4OJI
  ├─ DB に登録... ✅ 新規
```

## トラブルシューティング

**Q: Webhook から 4 本の動画が取得されたのに、2 本しか DB に登録されない**

A: `YOUTUBE_DEDUP_ENABLED=true` の場合、同じタイトル+チャンネルの動画は優先度ベースで管理されます。
デバッグしたい場合は `YOUTUBE_DEDUP_ENABLED=false` に変更してすべての動画を登録してください。

**Q: 設定を変更したが反映されない**

A: アプリケーションを再起動してください。config は起動時に読み込まれます。
