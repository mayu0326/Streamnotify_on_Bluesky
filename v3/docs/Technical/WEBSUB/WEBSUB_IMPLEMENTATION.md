# YouTube WebSub 通知機能 - 実装ガイド

**対象バージョン**: v3.3.0+
**最終更新**: 2026-01-03
**ステータス**: ⚠️ 部分実装（センターサーバー モデル機能追加、ローカルサーバー未実装）

---

## 📖 目次

1. [概要](#概要)
2. [WebSub とは](#websub-とは)
3. [導入手順](#導入手順)
4. [設定方法](#設定方法)
5. [フィード取得モード](#フィード取得モード)
6. [トンネル設定](#トンネル設定)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

YouTube チャンネルの新着動画情報を、従来の **RSS ポーリング** ではなく **YouTube の WebSub 通知（プッシュ型）** で受け取る機能を実装しました。

### メリット

| 特徴 | RSS ポーリング | WebSub | メリット |
|:--|:--:|:--:|:--|
| リアルタイム性 | ⏱️ 数分のラグ | ⚡ ほぼリアルタイム | **WebSub が優位** |
| 負荷（API呼び出し） | 📊 定期的 | 📡 イベント時のみ | **WebSub が優位** |
| セットアップ | ✅ 簡単 | 📝 やや複雑 | **RSS が優位** |
| 安定性 | ✅ 高い | 🔄 フォールバック機能 | **同等** |

### 実装済みの動作モード

```
┌─────────────┬──────────────────────┬──────────────────────────────┐
│ モード      │ 説明                 │ 実装状況                     │
├─────────────┼──────────────────────┼──────────────────────────────┤
│ poll        │ RSS ポーリング        │ ✅ 実装済み（従来方式）     │
│ websub      │ WebSub HTTP API      │ ✅ 部分実装（センターサーバー）│
│ hybrid      │ WebSub + ポーリング   │ ❌ 未実装（将来予定）       │
└─────────────┴──────────────────────┴──────────────────────────────┘
```

---

## WebSub とは

## WebSub と実装アーキテクチャ

### 従来の RSS ポーリング（実装済み）

```
┌────────────────────────────────────────────────────────────┐
│ あなたのアプリケーション    │
│ (main_v3.py)                │
└────────────┬─────────────────────────────────────────────────┘
             │
   10分ごと  │ RSS を取得
             │
             ↓
     ┌──────────────────────────────────────────────────┐
     │ YouTube RSS フィード                             │
     │ https://www.youtube.com/feeds/videos.xml?...    │
     └──────────────────────────────────────────────────┘
```

**特徴** ✅:
- シンプル・実装済み
- ❌ ラグが発生（数分～10分）

### v3 WebSub アーキテクチャ（センターサーバー モデル）

**ローカル Webhook サーバーは実装されていません** ❌
かわりに、センターサーバー（https://webhook.neco-server.net）が YouTube の WebSub を管理します。

```
┌─────────────────────────────────────────────────────────────────────────┐
│ YouTube チャンネル         │
│ （新着動画投稿）           │
└─────────────────────┬───────────────────────────────────────────────────┘
                      │
                      ↓ WebSub 通知
   ┌──────────────────────────────────────────────────────────────────────┐
   │ YouTube WebSub ハブ                               │
   │ pubsubhubbub.appspot.com                          │
   └──────────────────────────────────┬─────────────────────────────────────┘
                                      │
                                      ↓ 通知
   ┌──────────────────────────────────────────────────────────────────────────────┐
   │ センターサーバー                                                                  │
   │ https://webhook.neco-server.net                                              │
   │ (WebSub 集約・データ保管)                                      │
   └──────────────────────────────────────┬─────────────────────────────────────────┘
                                          │
   HTTP GET                               │
   定期ポーリング                          ↓
   ┌──────────────────────────────────────────────────────────────────────────────┐
   │ あなたのアプリケーション                                                      │
   │ (main_v3.py)                                                                  │
   │                                                                               │
   │ ProductionServerAPIClient                                                   │
   │ → /videos エンドポイント                                                     │
   └──────────────────────────────────────────────────────────────────────────────┘
```

**特徴** ⚠️:
- ✅ YouTube WebSub 対応（センターサーバー 経由）
- ✅ トンネル不要（センターサーバー が管理）
- ✅ 実装済み（youtube_websub.py, production_server_api_client.py）
- ❌ リアルタイムではない（センターサーバー からの定期 GET）
- ⚠️ センターサーバー 依存（停止時は動作不可）

## 導入手順

### ステップ 1: settings.env の設定

#### 1-1 フィード取得モードを選択

```env
# poll: RSS ポーリング（従来方式、トンネル不要）
# websub: WebSub HTTP API（推奨、センターサーバー 設定必須）
# hybrid: WebSub + ポーリング並用（v3.4.0+ 予定）

YOUTUBE_FEED_MODE=websub
```

#### 1-2 WebSub 設定（websub モード用）

```env
# センターサーバー の WebSub クライアント ID
WEBSUB_CLIENT_ID=my-websub-client

# センターサーバー の WebSub API キー
WEBSUB_CLIENT_API_KEY=your-api-key

# WebSub ポーリング間隔（分、デフォルト: 5、範囲: 3～30）
# センターサーバー からの動画データ取得間隔
YOUTUBE_WEBSUB_POLL_INTERVAL_MINUTES=5

# 注: ローカル Webhook サーバーは実装されていません(センターサーバーのため不要です)
# 注: トンネル設定（ngrok、Cloudflare）は不要です
# 注: VPNや固定IPアドレス、ドメイン、ファイアウォール設定等も不要です
```

### ステップ 2: センターサーバー の設定

**ローカル Webhook サーバーは実装されていません。** ✅ トンネル設定は不要です。

- かわりに、センターサーバー（https://webhook.neco-server.net）の設定が必要です。\
なお、WebsubCenterServer は作者が運営するサービスであり、一部の方に限って提供しております。

- Websub センターサーバー の利用にはクライアントIDとAPIキーが必要です。\
将来的には提供範囲を拡大することも検討していますが、具体的な日時は未定です。

#### センターサーバー へのクライアント登録

```bash
# 1. センターサーバー 管理者から指定された WebSubクライアントIDとAPIキーを登録
#    - WEBSUB_CLIENT_ID: クライアント識別子
#    - WEBSUB_CLIENT_API_KEY: API キー

# 2. settings.env に設定
WEBSUB_CLIENT_ID=my-websub-client
WEBSUB_CLIENT_API_KEY=your-api-key

# 3. YouTube チャンネル ID も設定
YOUTUBE_CHANNEL_ID=UCxxxxxxxxxxxxxxxx
```

#### センターサーバー の概要

センターサーバー は：
- ✅ YouTube WebSub ハブの購読・管理を行う
- ✅ プッシュ通知を受け取ってキャッシュする
- ✅ HTTP GET API で動画データを提供する
- 🚀 複数クライアントから同時アクセス可能


### ステップ 3: アプリケーション起動

```bash
python main_v3.py
```

**ログで確認**:

```
✅ WebSub マネージャーを初期化しました
   モード: websub

🔗 YouTube フィード取得モード: WebSub（Websubサーバー HTTP API 経由）
🔗 WebSub ポーリング間隔: 5 分

[YouTube] YouTubeWebSub の取得を準備しています...
[YouTube] WebSub の取得準備を完了しました

✅ YouTube フィード更新を確認しました
   新着動画: 2 件
```

---

## 設定方法

### GUI からの設定変更（v3.4.0+）

1. アプリケーション起動
2. **「🔧 プラグイン」ボタン → 「📡 WebSub 設定」タブ**
3. フィード取得モードを選択
4. コールバック URL を入力
5. **「購読する」ボタンでテスト購読**

### 設定値の説明

| 項目 | 値 | 説明 |
|:--|:--|:--|
| `YOUTUBE_FEED_MODE` | poll / websub | フィード取得方式（hybrid は未実装） |
| `WEBSUB_CLIENT_ID` | 文字列 | センターサーバー のクライアント ID |
| `WEBSUB_CLIENT_API_KEY` | 文字列 | センターサーバー の API キー |
| `YOUTUBE_WEBSUB_POLL_INTERVAL_MINUTES` | 3～30 | センターサーバー からのポーリング間隔 |
| `YOUTUBE_RSS_POLL_INTERVAL_MINUTES` | 10～60 | RSS ポーリング間隔（poll モード用） |

## フィード取得モード

### モード 1: poll（RSS ポーリング）

```
┌────────────────────────────────────────────────────────────┐
│ あなたのアプリケーション    │
│ (main_v3.py)                │
└────────────┬─────────────────────────────────────────────────┘
             │
   10分ごと  │ RSS を取得
             │
             ↓
     ┌──────────────────────────────────────────────────┐
     │ YouTube RSS フィード                             │
     │ https://www.youtube.com/feeds/videos.xml?...    │
     └──────────────────────────────────────────────────┘
```

**特徴** ✅:
- トンネル不要
- シンプル・実装済み
- 安定性高い
- ❌ ラグが発生（数分～10分）

**推奨環境**:
- ローカル環境テスト
- ネットワークが限定的
- リアルタイム対応不要

### モード 2: websub（WebSub - センターサーバー 経由）

```
┌──────────────────────────────────────────────────┐
│ 1. YouTube WebSub ハブ → センターサーバー          │
│    (センターサーバー が購読・管理)            　　　│
│                                                 │
│ 2. Polling ループ                          　　　 │
│    5分ごと HTTP GET                     　　　　   │
│    ProductionServerAPIClient           　　　    │
│    → センターサーバー /videos エンドポイント 　　　　 │
│                                                 │
│ 3. DB に保存                            　　　   │
└──────────────────────────────────────────────────┘
```

**特徴** ⚠️:
- ✅ YouTube WebSub 対応（センターサーバー 経由）
- ✅ トンネル不要
- ✅ 実装済み（youtube_websub.py, production_server_api_client.py）
- ❌ リアルタイムではない（センターサーバー からの定期 GET）
- ⚠️ センターサーバー 依存（停止時は動作不可）

**推奨環境**:
- センターサーバー に接続可能な環境
- ある程度のリアルタイム性が必要な場合

### モード 3: hybrid（ハイブリッド）

**❌ v3.3.0 では未実装**（v3.4.0+ 予定）

実装されたら、WebSub + ポーリング を並行実行し、フォールバック対応を実現します。

## トラブルシューティング

### Q1: WebSub 購読に失敗する

**原因**:
- コールバック URL が間違っている
- API キーが間違っている
- クライアント ID が間違っている
- センターサーバー に登録されていないクライアント
- 通信環境の問題
- その他 センターサーバー 側の問題

**対応**:

```
1. センターサーバー への疎通確認
   $ curl https://webhook.neco-server.net/health

2. コールバック URL を確認
   WEBSUB_CALLBACK_URL=https://webhook.neco-server.net/pubsub
   （http:// ではなく https:// か確認）

3. API キーとクライアント ID を確認
   settings.env の WEBSUB_CLIENT_ID, WEBSUB_CLIENT_API_KEY

4. ログを確認
   $ grep "WebSub" logs/app.log
```

### Q2: Webhook で新着取得できない

**原因**:
- 購読がまだ完了していない（センターサーバーに登録されていない）
- 通信環境が悪い（ネットワーク障害など）
- データがまだセンターサーバーに到着していない（YouTube 側の遅延など）

**対応**:

```
1. 購読状態を確認
   管理者からクライアントIDとAPIキーを受け取っている場合は、登録がされています。

2. Webhook エンドポイントのログを確認
   $ grep "webhook/youtube" logs/app.log

3. YouTubeStudioから動画の公開設定を変更して戻してみる。
   公開設定を変更すると、YouTubeWebSubの反応遅延が解消される場合があります。

4. ポーリングで代替
   YOUTUBE_FEED_MODE=hybrid で、ポーリングをバックアップに設定
```

### Q3: センターサーバーに接続できない

**原因**: 通信障害やサーバーメンテナンスの場合があります。

**対応**:

```
方法 1: Cloudflareに障害が発生していないか確認してください
方法 2: VPNやプロキシを無効化して再試行してください
方法 3: ヘルスチェックエンドポイントへの疎通が可能か確認してください
方法 4: 一時的に RSS ポーリングモードに切り替えてください
方法 5: センターサーバー 管理者に問い合わせてください(メンテナンス中の場合があります)
```

### Q4: WebSub モード時、新着動画が遅延する

**原因**:
- YouTube の WebSub ハブのキャッシュ遅延
- ローカルネットワークの遅延
- トンネルの遅延

**対応**:

```
1. ハイブリッドモードを使用
   YOUTUBE_FEED_MODE=hybrid
   （ポーリングがバックアップになる）

2. ポーリング間隔を短縮
   POLL_INTERVAL_MINUTES=5

3. ネットワーク遅延を確認
   $ ping ngrok-server
```

---

## 詳細なログ出力

### WebSub 関連のログを抽出

```bash
# Linux / Mac
grep -E "(WebSub|webhook|購読)" logs/app.log

# Windows PowerShell
Select-String -Pattern "(WebSub|webhook|購読)" logs/app.log
```

### ログレベルを上げる

```env
LOG_LEVEL_APP=DEBUG
DEBUG_MODE=true
```

---

## よくある質問（FAQ）

### Q: WebSub と ポーリングはどちらを使うべき？

**A**: 以下の基準で判断してください：

- **ローカル環境・テスト** → `poll`（トンネル不要）
- **本番環境・リアルタイム必須** → `hybrid`（推奨）
- **細かい制御** → `websub`（上級）

### Q: WebSub 購読は自動で更新される？

**A**: はい。購読期間の 70% 経過時に自動更新されます。

```
購読期間: 5日（432000秒）
↓
70% 経過: 3.5日 後
↓
自動更新: 再度 WebSub 購読
```

### Q: ポーリング間隔を短くしても大丈夫？

**A**: WebSub モード時は無視されます。Hybrid モード時は短くできます。

```env
YOUTUBE_FEED_MODE=hybrid
POLL_INTERVAL_MINUTES=5  # 最短 5分（バックアップ用）
```

### Q: 複数チャンネルを監視できる？

**A**: 現在は 1 チャンネルのみ対応です。複数チャンネル監視は v3.5.0+ を参照してください。

---

## 関連ファイル

- `youtube_websub.py` - WebSub マネージャー実装
- `websub_webhook_handler.py` - Webhook ハンドラー実装
- `websub_settings_panel.py` - GUI 設定パネル
- `config.py` - 設定管理（WebSub 設定追加）
- `main_v3.py` - メインループ統合

---

## 技術仕様

### センターサーバー API フロー（v3.3.0）

v3.3.0 では、YouTube WebSub を センターサーバー が管理し、
あなたのアプリケーションは センターサーバー から HTTP GET でデータを取得します。

#### フロー図

```
┌─────────────────────────────────────────────────┐
│ YouTube WebSub ハブ                             │
└─────────────────────────────────────────────────┘
           ↓ (プッシュ通知)
┌─────────────────────────────────────────────────┐
│ センターサーバー (webhook.neco-server.net)        │
│ - YouTube WebSub 購読を管理                     │
│ - 動画情報をキャッシュ                           │
└─────────────────────────────────────────────────┘
           ↑ (HTTP GET /videos)
┌─────────────────────────────────────────────────┐
│ あなたのアプリケーション                         │
│ - 5分ごとに センターサーバー に GET                │
│ - 動画情報を DB に保存                          │
└─────────────────────────────────────────────────┘
```

#### 実装例

```python
# main_v3.py
if config.youtube_feed_mode == "websub":
    yt_rss = get_youtube_websub(config.youtube_channel_id)
    videos = yt_rss.get_websub_videos(limit=15)
    # DB に保存
    for video in videos:
        db.insert_video(...)
```

### ポーリング vs WebSub（センターサーバー）の比較

| 項目 | Poll | WebSub（センターサーバー） |
|:--|:--|:--|
| データ取得元 | YouTube RSS フィード | センターサーバー キャッシュ |
| リアルタイム性 | ❌ 低（数分ラグ） | ⚠️ 中（遅延あり、YouTube の遅延に依存） |
| トンネル | ❌ 不要 | ❌ 不要 |
| ローカル webhook | ❌ 不要 | ❌ 不要 |
| 実装複雑度 | ✅ シンプル | ⚠️ 中程度（API クライアント） |
| センターサーバー 依存 | ❌ なし | ✅ あり |
| v3.3.0 実装状況 | ✅ 完全実装 | ✅ 完全実装 |

---

## 関連ファイル

### ✅ v3.3.0 で実装済み

- `youtube_core/youtube_websub.py` - WebSub マネージャー実装（センターサーバー API 対応）
- `production_server_api_client.py` - センターサーバー HTTP API クライアント
- `config.py` - 設定管理（YOUTUBE_FEED_MODE, YOUTUBE_WEBSUB_POLL_INTERVAL_MINUTES）
- `main_v3.py` - メインループ統合（poll/websub のモード分岐）

### ⏳ 将来実装予定（v3.4.0+）

- `websub_settings_panel.py` - GUI 設定パネル（v3.4.0+ 予定）
- ローカル Webhook サーバー実装（v3.5.0+ 予定）

---

## 実装チェックリスト

| 機能 | v3.3.0 | v3.4.0+ | 詳細 |
|:--|:--:|:--:|:--|
| Poll モード（RSS） | ✅ | ✅ | RSS ポーリング・完全実装 |
| WebSub（センターサーバー） | ✅ | ✅ | センターサーバー HTTP API・完全実装 |
| Hybrid モード | ❌ | ⏳ | v3.4.0+ 実装予定 |
| ローカル Webhook | ❌ | ⏳ | v3.5.0+ 実装予定 |
| GUI 設定パネル | ❌ | ⏳ | v3.4.0+ 実装予定 |

---

**作成日**: 2025-12-24
**最後の修正**: 2026-01-03
**ステータス**: ⚠️ 部分実装（v3.3.0 センターサーバー モデル）
