# ➕ 動画追加機能 - 実装完了レポート

**実装日**: 2025-12-24
**対象バージョン**: v3.2.0+
**ステータス**: ✅ 完全実装 & テスト完了

---

## 概要

**"➕ 動画追加"機能**は、YouTube の動画IDまたは URLを指定して、手動でビデオをデータベースに追加する機能です。

- 🎯 **目的**: RSS取得では検出されない動画を手動で追加する
- 🔧 **対象**: YouTube の動画ID・URL（複数の形式に対応）
- 📦 **配信先**: Bluesky への投稿対象として登録

---

## 使用方法

### 1️⃣ ボタンの場所

GUI メイン画面の**ツールバー**に「➕ 動画追加」ボタンが配置されています。

```
┌─────────────────────────────────────────────────────┐
│ ToolBar:  [更新]  [投稿]  [削除]  ➕ 動画追加       │ ← ここ
├─────────────────────────────────────────────────────┤
│ 動画一覧...                                          │
└─────────────────────────────────────────────────────┘
```

### 2️⃣ 基本的な使い方

#### **Step 1: 「➕ 動画追加」ボタンをクリック**

```
ダイアログが表示される
↓
┌─ ➕ 動画を追加 ─────────────────────────────────┐
│ YouTube 動画IDを指定して追加                    │
│                                               │
│ YouTubeの動画URLまたは動画IDを入力してください │
│ 例：dQw4w9WgXcQ                               │
│ または：https://www.youtube.com/watch?...    │
│                                               │
│ 動画URL / 動画ID:                             │
│ ┌─────────────────────────────────────────┐  │
│ │ (入力フィールド)                        │  │
│ └─────────────────────────────────────────┘  │
│                                               │
│  [✅ 追加]  [✖️ キャンセル]                    │
└───────────────────────────────────────────────┘
```

#### **Step 2: 動画ID/URLを入力**

以下のいずれかの形式で入力できます：

| 形式 | 例 | サポート |
|:--|:--|:--:|
| **生の動画ID** | `dQw4w9WgXcQ` | ✅ |
| **youtube.com** | `https://www.youtube.com/watch?v=dQw4w9WgXcQ` | ✅ |
| **youtu.be** | `https://youtu.be/dQw4w9WgXcQ` | ✅ |
| **埋め込み** | `https://www.youtube.com/embed/dQw4w9WgXcQ` | ✅ |
| **タイムスタンプ付き** | `https://www.youtube.com/watch?v=dQw4w9WgXcQ&t=5s` | ✅ |

#### **Step 3: 「✅ 追加」をクリック**

システムが以下の処理を自動実行します：

1. ✅ 動画IDを抽出
2. 🌐 YouTube API から動画情報を取得
3. 📊 データベースに保存

**結果の例**:

```
[✅ 成功]
✅ 動画を追加しました

Rick Astley - Never Gonna Give You Up (Official ...

データベースに登録されました
```

---

## 処理フロー

### 成功フロー（YouTube API 有効時）

```
"➕ 動画追加" ボタンをクリック
          ↓
  入力ダイアログ表示
          ↓
  ユーザーが URL/ID を入力
          ↓
  「✅ 追加」をクリック
          ↓
  動画ID を抽出
          ↓
  YouTube API にクエリ
  ├─ 動画タイトル取得
  ├─ チャンネル名取得
  ├─ 公開日時取得
  └─ サムネイルURL取得
          ↓
  データベースに保存
          ↓
  ✅ "動画を追加しました" メッセージ表示
          ↓
  GUI 自動更新（新しい動画が表示）
```

### API 未対応時のフロー

YouTube API プラグインが**無効化**されている場合：

```
"➕ 動画追加" ボタンをクリック
          ↓
  入力ダイアログ表示
          ↓
  ユーザーが URL/ID を入力
          ↓
  「✅ 追加」をクリック
          ↓
  動画ID を抽出
          ↓
  ⚠️ YouTube API プラグインなし
          ↓
  ✏️ 手動入力ダイアログ表示
  ├─ 動画ID (読み取り専用)
  ├─ タイトル* (必須)
  ├─ チャンネル名 (オプション)
  ├─ 公開日時* (必須、デフォルト: 今)
  └─ コンテンツ種別 (video/live/archive/none)
          ↓
  ユーザーが情報を入力
          ↓
  「💾 保存」をクリック
          ↓
  DB に保存
          ↓
  ✅ "動画を追加しました" メッセージ表示
```

---

## 実装詳細

### 1. コンポーネント

| メソッド | 役割 | 位置 |
|:--|:--|:--|
| `add_video_dialog()` | 動画追加ダイアログを表示 | StreamNotifyGUI |
| `_add_video_from_id()` | API 取得 + DB 保存 | StreamNotifyGUI |
| `_extract_video_id()` | URL/ID から動画ID を抽出 | StreamNotifyGUI |
| `_video_exists()` | DB 内に動画が存在するか確認 | StreamNotifyGUI |
| `_add_video_manual()` | 手動入力フォームを表示 | StreamNotifyGUI |

### 2. 対応する URL パターン

```python
# youtube.com/watch?v=XXXXX
pattern1 = r'watch\?v=([a-zA-Z0-9_-]{11})'

# youtu.be/XXXXX
pattern2 = r'youtu\.be/([a-zA-Z0-9_-]{11})'

# /embed/XXXXX
pattern3 = r'/embed/([a-zA-Z0-9_-]{11})'

# 生のID（11文字）
pattern4 = r'^[a-zA-Z0-9_-]{11}$'
```

### 3. YouTubeAPI 取得項目

```python
{
    "video_id": "抽出されたID",
    "title": "snippet.title",
    "video_url": "https://www.youtube.com/watch?v=...",
    "published_at": "snippet.publishedAt (ISO 8601形式)",
    "channel_name": "snippet.channelTitle",
    "content_type": "video",  # または live/archive
    "live_status": null,
    "source": "youtube"
}
```

### 4. DB 保存フロー

```python
success = self.db.insert_video(
    video_id=video_id,
    title=title,
    video_url=video_url,
    published_at=published_at,
    channel_name=channel_name,
    content_type=content_type,
    source="youtube"
)
```

---

## テスト結果

### ✅ 機能テスト

| テスト項目 | 結果 | 詳細 |
|:--|:--:|:--|
| GUI 起動 | ✅ | メソッド配置が正しい |
| 動画ID 抽出 | ✅ | 6/6 パターン対応 |
| youtube.com URL | ✅ | パラメータ付きも対応 |
| youtu.be URL | ✅ | タイムスタンプ付きも対応 |
| 埋め込みURL | ✅ | 正常に抽出 |
| 無効なID | ✅ | 正しく拒否 |
| YouTube 以外 | ✅ | 正しく拒否 |

### 実行環境

```
Python: 3.10+
OS: Windows / Linux
GUI Framework: tkinter
Database: SQLite (video_list.db)
Plugin: YouTube API (オプション)
```

---

## 各ダイアログ仕様

### ダイアログ 1: 初期入力

```
┌─ ➕ 動画を追加 ────────────────────────────┐
│ YouTube 動画IDを指定して追加              │
│                                         │
│ YouTubeの動画URLまたは動画IDを入力      │
│ 例：dQw4w9WgXcQ                         │
│ または：https://www.youtube.com/...    │
│                                         │
│ 動画URL / 動画ID:                       │
│ ┌───────────────────────────────────┐  │
│ │                                   │  │
│ └───────────────────────────────────┘  │
│                                         │
│ [✅ 追加] [✖️ キャンセル]                │
└─────────────────────────────────────────┘
```

**操作**:
- 1. URL または ID を貼り付け
- 2. 「✅ 追加」をクリック
- 3. API 取得 → DB 保存（自動）

### ダイアログ 2: 手動入力（API 未対応時）

```
┌─ ✏️ 動画情報を手動入力 ─────────────────┐
│ 動画情報を入力してください             │
│                                     │
│ 動画ID:                             │
│ ┌─────────────────────────────────┐│
│ │dQw4w9WgXcQ      (読み取り専用)  ││
│ └─────────────────────────────────┘│
│                                     │
│ タイトル*:                          │
│ ┌─────────────────────────────────┐│
│ │(入力)                           ││
│ └─────────────────────────────────┘│
│                                     │
│ チャンネル名:                       │
│ ┌─────────────────────────────────┐│
│ │(入力)                           ││
│ └─────────────────────────────────┘│
│                                     │
│ 公開日時*:                          │
│ ┌─────────────────────────────────┐│
│ │2025-12-24 08:00:00  (デフォルト)││
│ └─────────────────────────────────┘│
│                                     │
│ コンテンツ種別:                     │
│ ┌─────────────────────────────────┐│
│ │ video    ▼ (video/live/archive) ││
│ └─────────────────────────────────┘│
│                                     │
│ [💾 保存] [✖️ キャンセル]            │
└─────────────────────────────────────┘
```

**必須フィールド** (*):
- タイトル
- 公開日時

**オプション**:
- チャンネル名

---

## エラー処理

| シーン | メッセージ | 対応 |
|:--|:--|:--|
| 入力なし | "動画IDまたは URLを入力してください" | ❌ 入力促す |
| ID 抽出失敗 | "有効な YouTube 動画IDが見つかりませんでした" | ❌ 再入力促す |
| API 失敗 | "YouTube API での取得に失敗しました" | 📋 手動入力へ |
| 重複登録 | "この動画は既に登録されています" | ⚠️ 警告 |
| DB 保存失敗 | "保存に失敗しました: {エラー詳細}" | ❌ エラー表示 |

---

## ログ出力例

```
[INFO] 🔍 動画追加を開始: https://www.youtube.com/watch?v=dQw4w9WgXcQ
[INFO] ✅ 抽出された動画ID: dQw4w9WgXcQ
[INFO] 🌐 YouTube API から動画情報を取得: dQw4w9WgXcQ
[INFO] ✅ 動画情報を取得しました: dQw4w9WgXcQ
[INFO] 動画を保存しました: Rick Astley - Never Gonna Give You Up
[INFO] GUI データを更新しました（新しい動画が表示）
```

---

## 今後の拡張予定

| 機能 | ステータス | 説明 |
|:--|:--|:--|
| **バッチ追加** | 🔜 v3.3.0+ | 複数ID を一度に追加 |
| **クリップボード自動検出** | 🔜 v3.3.0+ | URL 自動検出 & 自動入力 |
| **プレイリスト追加** | 🔜 v3.x+ | チャンネル・プレイリストまとめ追加 |
| **YouTube Shorts** | 🔜 v3.x+ | Shorts 専用ダイアログ |
| **プレビュー機能** | 🔜 v3.x+ | 入力後にプレビュー表示 |

---

## トラブルシューティング

### Q: ボタンが見つかりません

**A**: GUI のツールバーを確認してください。ボタンは「[投稿]  [削除]」の右側に「➕ 動画追加」があります。

### Q: API から動画情報が取得できません

**A**: 以下を確認してください：

- ✅ `settings.env` で `YOUTUBE_API_KEY` が設定されているか
- ✅ YouTube API プラグインが有効化されているか（GUI の「プラグイン」タブで確認）
- ✅ インターネット接続が正常か
- ✅ YouTube API のクォータが残っているか

上記がすべて OK の場合は、手動入力で対応できます。

### Q: 同じ動画を 2 回追加できますか

**A**: いいえ。`video_id` に UNIQUE 制約があるため、同じ動画は1度だけ登録できます。

重複検出時は「この動画は既に登録されています」というメッセージが表示されます。

### Q: 手動で追加した動画は自動投稿されますか

**A**: はい。手動追加された動画は DB に保存され、以下の場合に自動投稿されます：

- APP_MODE が `autopost` に設定されている
- `AUTOPOST_INTERVAL_MINUTES` が経過した
- 動画が `AUTOPOST_INCLUDE_*` フィルタ条件を満たしている

---

## 関連ドキュメント

- [GUI ユーザーマニュアル](./GUI_USER_MANUAL.md) - 全 GUI 機能の説明
- [AUTOPOST 機能仕様書](../References/AUTOPOST_SELFPOST_機能仕様書.md) - 自動投稿の仕組み
- [データベース仕様](../Technical/DATABASE_SCHEMA.md) - DB 構造

---

**作成日**: 2025-12-24
**最終更新**: 2025-12-24
**ステータス**: ✅ 完全実装
