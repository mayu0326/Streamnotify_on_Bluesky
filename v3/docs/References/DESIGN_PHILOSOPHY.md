# Streamnotify on Bluesky - 設計思想とアーキテクチャ哲学

**対象バージョン**: v3.1.0 以降
**最終更新**: 2025-12-23
**ステータス**: ✅ 確定（v3.1.0以降の基本方針）

---

## 📖 目次

1. [設計思想の核](#設計思想の核)
2. [なぜローカル完結なのか](#なぜローカル完結なのか)
3. [リアルタイム性の現実的な判断](#リアルタイム性の現実的な判断)
4. [各プラットフォーム別の実装方針](#各プラットフォーム別の実装方針)
5. [拡張性とのバランス](#拡張性とのバランス)
6. [ユーザーへの価値提供](#ユーザーへの価値提供)
7. [将来の応用パターン](#将来の応用パターン)

---

## 設計思想の核

### 三つの約束

Streamnotify on Bluesky は、ユーザーに対して三つの約束をしています：

#### 1. ✅ ローカル完結

```
「あなたのパソコンの中だけで完結します」

✅ VPS・レンタルサーバー不要
✅ 追加の月額費用 0 円
✅ 自分の環境・自分のペースで動かせる
✅ インターネット障害時も、サービス停止に左右されない
```

#### 2. ✅ シンプル設定

```
「難しい設定をさせません」

✅ API キーをコピペするだけ
✅ Webhook URL や DNS 設定なし
✅ settings.env にキー張付けるだけ
✅ 素人でも 5 分で動く
```

#### 3. ✅ 無料・保守容易

```
「あなたに金銭的・運用的な負担をかけません」

✅ 本体のコストは永遠に 0 円
✅ VPS 契約不要だから月額費用なし
✅ セキュリティ複雑さなし（Webhook署名検証不要）
✅ トラブル時の対応も、本体の改善で対応可能
```

---

## なぜローカル完結なのか

### 歴史的背景：設計当初の課題感

このプロジェクトは、以下の課題を背景に誕生しました：

| 課題 | 従来の解決策 | デメリット |
|:--|:--|:--|
| **配信枠立て検知が遅い** | YouTubeの Webhook (WebSub) | ユーザーがサーバーを立てる必要 |
| **Twitch 通知が欲しい** | Twitch EventSub | VPS・固定IP・ドメイン必須 |
| **Discord 統合したい** | Discord Bot ホスティング | インフラ・セキュリティ学習必須 |

### 「自分たちで解決する」という選択

当プロジェクトの作者（まゆにゃ）は、これら課題に対して以下の道を選びました：

```
「ユーザーに複雑さを押し付けるのではなく、
  クライアント側で工夫して、シンプルなまま実現する」
```

**例**:

| ニーズ | 「普通」の実装 | 本プロジェクト |
|:--|:--|:--|
| YouTube 通知 | WebSub サーバー（インフラ必須） | RSS ポーリング（クライアント単体） |
| YouTube Live 判定 | YouTube API（高頻度呼び出し） | YouTube Live Plugin（スマート判定） |
| Twitch 通知 | EventSub + Webhook | Twitch API ポーリング（クライアント単体） |
| テンプレート管理 | 設定ファイルを手打ち | GUI + Asset Manager（自動配置） |

---

## リアルタイム性の現実的な判断

### 「完全リアルタイム」と「実用的リアルタイム」と「ほぼリアルタイム」

重要な区別があります：

#### 完全リアルタイム（秒単位）

```
YouTube Live 配信開始
  ↓ (0.1秒以内)
クライアント通知
```

**必要なもの**:
- WebSub / EventSub サーバー
- VPS（¥300-1000/月）
- HTTPS 公開
- Webhook 署名検証
- セキュリティ考慮

**コスト**:
- 金銭: ¥3,600-12,000/年
- 手間: 1-2日の学習・構築
- 保守: 定期確認・バージョン更新

#### 実用的リアルタイム（3-5分）

```
YouTube Live 配信開始
  ↓ (3-5分待機)
クライアント通知
```

**必要なもの**:
- RSS ポーリング
- ローカル SQLite
- Python スクリプト

**コスト**:
- 金銭: 0 円
- 手間: 5分のセットアップ
- 保守: ほぼ不要

### 現実的な選択

```
「秒単位のリアルタイムは欲しいが、
  VPS を契約して複雑に管理するのは嫌」

という望郷は、数学的に **二者択一** です。

本プロジェクトは、ユーザーの負担を最小化するため、
「3-5 分の遅延は許容、インフラ・複雑さはゼロ」
という選択をしています。
```

### リアルタイム性の遅延の原因

| 要因 | 遅延 | 責任 |
|:--|:--:|:--|
| RSS 更新待ち | 2-5 分 | YouTube（不可抗力） |
| ポーリング間隔 | 0-5 分 | クライアント設定 |
| DB 保存 + 投稿処理 | 数秒 | 本アプリ |
| **合計** | **3-10 分** | **仕様** |

### ほぼリアルタイム(1分以内)の将来性
将来的には、以下のような応用パターンで 1 分以内の検知も可能です：

- 一部の方限定にはなってしまいますが、ほぼリアルタイムで通知を受け取ることができる、 \
「YouTube Websub/Webhook」をセンターサーバー方式で提供しています。
- 詳細は、お問い合わせください。

---

## 各プラットフォーム別の実装方針

### YouTube

#### 現在の実装

```
RSS ポーリング（5分ごと）または WebSub (Webhook)※１分間隔可能
  ├─ 新着動画 → database に登録
  ├─ YouTube API で詳細情報取得（Live/Archive 判定）
  └─ テンプレート適用 → Bluesky 投稿
```

#### なぜこの方式か

- ✅ クライアント単体で完結
- ✅ YouTube 側が RSS 提供している（公式）
- ✅ API キーは「詳細取得」の補助用
- ✅ ユーザーは「チャンネル ID」だけで動く
※ WebSub はサーバーアドレスとと任意名称の設定が必要です。

#### 将来の可能性

- PubSubHubbub: ユーザーが自力で WebSub サーバーを立てた場合の連携は可能です。
  （本プロジェクトでは一般提供しません。限定提供は準備中です）

### Niconico

#### 現在の実装

```
RSS ポーリング（10分ごと）
  ├─ 新着動画 → database に登録
  ├─ ユーザー名自動取得（複数方式対応）
  └─ テンプレート適用 → Bluesky 投稿
```

#### なぜこの方式か

- ✅ RSS が公式提供
- ✅ API キー不要
- ✅ ユーザー ID だけで動く
- ✅ 最もシンプル

### Twitch（将来実装方針）

#### 採用方式：API ポーリング（EventSub ではない）
- 将来的にはこちらもWebsub/EventSub対応(センターサーバー方式)を検討していますが、
  現状は以下の理由で API ポーリングを採用予定です：

```
Helix API ポーリング（5分ごと）
  ├─ /helix/streams で配信状態確認
  ├─ 配信開始/終了を検知
  ├─ テンプレート適用 → Bluesky 投稿
```

#### なぜ EventSub ではなくポーリングか

| 比較項目 | EventSub (Webhook) | API ポーリング |
|:--|:--:|:--:|
| リアルタイム | ✅ 秒単位 | ❌ 3-5分 |
| インフラ | ❌ VPS 必須 | ✅ 不要 |
| 複雑度 | ❌ 高 | ✅ 低 |
| ユーザー設定 | ❌ 難しい | ✅ API キーのみ |
| 本プロジェクト採用 | ❌ | ✅ |

**理由**:

```
秒単位のリアルタイム（EventSub）
  vs.
ユーザーが VPS を契約・管理する負荷

本プロジェクトは後者を **重大課題** と考え、
「3-5分の遅延は許容、インフラはゼロ」を選択。
```

- インフラ環境さえ整えばWebsub/EventSub方式も可能ですが、
  本プロジェクトではユーザーにその構築や負担を強いることは避けます。
  将来的には、センターサーバー方式での限定提供を検討しています。

---

## 拡張性とのバランス

### プラグインアーキテクチャの位置づけ

本プロジェクトのプラグイン設計は、以下の二つの目的があります：

#### 1. コア機能の拡張（本体に組み込む想定）

```
追加サービス対応:
  YouTube API ← v2.3.0 で実装
  YouTube Live ← v2.3.0 で実装
  Niconico ← v2.x で実装
  Twitch API ← v3.4.0+ 予定
```

**特徴**:
- ✅ ローカル完結という原則を守る
- ✅ 本体と同じシンプル設定
- ✅ 保守は本体と一緒
- ✅ サーバー型になってもユーザーの負担は増えない。1度の設定でOK


#### 2. 応用・カスタマイズ（ユーザー側の選択肢）

```
ユーザーが自力で実装する応用:
  - PubSubHubbub サーバー構築
  - Twitch EventSub Webhook
  - Discord Bot ホスティング
  - センターサーバー構築
  - 限定提供 API との 連携
  - その他外部連携
```

**特徴**:
- ❌ 本プロジェクトのサポート範囲外
- ✅ でも「連携インターフェース」は用意する
- ✅ 詳細ドキュメント参照

### 「本体機能」と「応用」の区別

```
本体機能（v3.1.0 コア）
  ├─ YouTube RSS + API
  ├─ Niconico RSS
  ├─ Bluesky 投稿
  ├─ テンプレートシステム
  └─ GUI 管理画面

  設計思想: ローカル完結・シンプル設定・無料
  ターゲット: 初心者～上級者

応用パターン（ユーザー側で選択可能）
  ├─ PubSubHubbub サーバー構築
  ├─ Twitch EventSub 連携
  ├─ センターサーバー方式(自家構築)
  ├─ センターサーバー方式(限定提供)
  └─ Discord Bot 統合

  設計思想:「本体とは別の領域」
  ターゲット: 開発者・応用志向
```

---

## ユーザーへの価値提供

### 本体（ローカル完結）での価値

| ユーザー像 | メリット |
|:--|:--|
| **YouTube/Niconico 配信者** | 「新着投稿」を自動 Bluesky 通知。設定 5分。 |
| **推し活垢運営者** | 配信開始を見逃さない。VPS 不要。完全プライベート。 |
| **技術初心者** | GUI でポチポチ、難しい知識不要。 |
| **テック好き** | Python+SQLite で遊べる。カスタマイズ容易。 |

### 応用（ユーザー側拡張）での価値

| ユーザー像 | 選択肢 |
|:--|:--|
| **秒単位が必須** | WebSub / EventSub サーバー構築（自力） |
| **複数サーバー管理したい** | センターサーバー + 複数クライアント |
| **高度な通知制御が必須** | 応用連携インターフェース参照 |

---

## 将来の応用パターン

### パターン A: シンプル利用（推奨）

```
本体のみで十分
  ↓
YouTube/Niconico RSS + Bluesky 投稿
  ↓
「3-5分遅延でいい」という判断のユーザー向け
```

**特徴**:
- 本体一つで完結
- VPS 不要
- 保守ほぼ不要
- ターゲット: 大多数のユーザー

### パターン B: リアルタイム強化（ユーザー側）

```
本体 + WebSub サーバー
  ↓
YouTube WebSub + Niconico RSS + Bluesky 投稿
  ↓
「秒単位が必須」というユーザー向け（自力構築）もしくは限定提供API利用
```

**特徴**:
- ユーザーが WebSub サーバーを立てる
- 本体は WebSub からのイベント受け取り対応
- 本体サポート: インターフェース定義のみ

### パターン C: 複合利用（ユーザー側）

```
複数クライアント + センターサーバー
  ↓
YouTube WebSub / Twitch EventSub を一元管理
  ↓
複数マシンから、同一の通知源を共有したいユーザー向け
```

**特徴**:
- ユーザーが センターサーバーを構築
- 各クライアントは簡軽ポーリング
- 本体サポート: API 連携仕様のみ

---

## 設計哲学の一貫性チェック

### 実装判断の基準

新機能追加時は、以下の問いに答える必要があります：

#### Q1. ユーザーに追加インフラ（VPS等）を強要しないか？

```
YES → 実装OK（本体機能）
NO  → ドキュメント化のみ（応用パターン）
```

#### Q2. ユーザーが難しい設定をさせないか？

```
YES （API キー張付けるだけ）
  → 実装OK（本体機能）

NO  （DNS 設定・トンネルL・VPN設定・署名検証）
  → ドキュメント化のみ（応用パターン）
```

#### Q3. 本体の保守負荷は増えないか？

```
YES （内部実装で解決できる）
  → 実装OK（本体機能）

NO  （外部サービス依存・仕様変更リスク大）
  → 慎重に検討（応用パターン推奨）
```

### 判定フロー図

```
新機能提案
  ↓
Q1. インフラ追加必須？
  ├─ YES → 「応用パターン」へ
  │
  └─ NO
       ↓
       Q2. 難しい設定？
         ├─ YES → 「応用パターン」へ
         │
         └─ NO
              ↓
              Q3. 本体保守負荷大？
                ├─ YES → 「応用パターン」へ
                │
                └─ NO
                     ↓
                     ✅ 本体機能として実装OK
```

---

## ドキュメント更新スケジュール

| 更新内容 | 対象ドキュメント | 予定 |
|:--|:--|:--|
| **本設計思想の確定** | このファイル | ✅ 2025-12-23 |
| **FUTURE_ROADMAP 更新** | FUTURE_ROADMAP_v3.md | ✅ 2025-12-23 |
| **Twitch 実装ガイド** | TWITCH_POLLING_IMPLEMENTATION.md | ✅ 2025-12-23 |
| **応用パターンガイド** | CENTER_SERVER_INTEGRATION_SPEC.md（別作成予定） | 🔜 2026-01 |
| **プラグイン開発ガイド** | PLUGIN_DEVELOPMENT_GUIDE.md（別作成予定） | 🔜 2026-01 |

---

## まとめ

### 三つの約束を守り抜く

Streamnotify on Bluesky は、以下の三つを徹底することで、
ユーザーに真の価値を提供しています：

```
✅ ローカル完結   → VPS・金銭不要
✅ シンプル設定   → 技術知識不要
✅ 無料・保守容易 → 長く使い続けられる
```

### 「これ以上シンプルにできない」設計

新機能追加時も、これらの原則が守られない場合は、
**「応用パターン」として別ドキュメント化** し、
本体機能に組み込まない方針を取ります。

### ユーザーへのメッセージ

```
このアプリは、
「難しいことを簡単に」ではなく、
「最初から難しくない」を貫いています。

複雑な用途が必要な場合は、
応用パターンのドキュメントを参照してください。
```

---

**作成日**: 2025-12-23
**ステータス**: ✅ 確定方針
**対象**: v3.1.0 以降の全実装
**レビュー**: 完了
