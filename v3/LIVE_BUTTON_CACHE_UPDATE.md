# Liveåˆ¤å®šãƒœã‚¿ãƒ³ä¿®æ­£ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªãƒ»APIæ›´æ–°

**æ›´æ–°æ—¥**: 2026-01-03
**å¯¾è±¡**: v3/gui_v3.py ã® `classify_youtube_live_manually()` ãƒ¡ã‚½ãƒƒãƒ‰

---

## ä¿®æ­£æ¦‚è¦

Liveåˆ¤å®šãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’ã€**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª â†’ APIæ›´æ–° â†’ åˆ†é¡ãƒ»DBæ›´æ–°**ãƒ•ãƒ­ãƒ¼ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

å‹•ç”»å–å¾—ã¨è‡ªå‹•æŠ•ç¨¿ã¯è¡Œã„ã¾ã›ã‚“ã€‚

---

## å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†“
ã€1ã€‘ YouTube API ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç¢ºèª
  â†“
ã€2ã€‘ DB ã‹ã‚‰ Live é–¢é€£å‹•ç”»ã‚’å–å¾—
      (content_type = schedule/live/completed/archive)
  â†“
ã€3ã€‘ å„å‹•ç”»ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
      â”œ æœ‰åŠ¹æœŸé™å†…ï¼ˆ30åˆ†ä»¥å†…ï¼‰: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
      â”” 30åˆ†ä»¥ä¸Šå¤ã„: API ã‹ã‚‰æœ€æ–°æƒ…å ±å–å¾—
  â†“
ã€4ã€‘ åˆ†é¡å™¨ã§å‹•ç”»ç¨®åˆ¥ã‚’åˆ¤å®š
      (type: schedule/live/completed/archive)
  â†“
ã€5ã€‘ DB ã«åˆ†é¡çµæœã‚’åæ˜ 
      (update_video_status â†’ content_type, live_status æ›´æ–°)
  â†“
ã€6ã€‘ æŠ•ç¨¿ãªã—ï¼ˆå‹•ç”»å–å¾—ãƒ»è‡ªå‹•æŠ•ç¨¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  â†“
çµæœè¡¨ç¤ºãƒ»DBå†èª­è¾¼
```

---

## å®Ÿè£…è©³ç´°

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™

```python
CACHE_VALIDITY_SECONDS = 30 * 60  # 30åˆ†
```

- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒ 30åˆ†ä»¥ä¸Šå¤ã„ â†’ **API ã‹ã‚‰æ›´æ–°**
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒ 30åˆ†ä»¥å†… â†’ **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—**

### çµ±è¨ˆæƒ…å ±

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã«ä»¥ä¸‹ã‚’è¡¨ç¤ºï¼š

```
âœ… YouTube Live åˆ¤å®šå®Œäº†

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª: N ä»¶
API æ›´æ–°: M ä»¶
DB æ›´æ–°: K ä»¶

â€» å‹•ç”»å–å¾—ã¨è‡ªå‹•æŠ•ç¨¿ã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚
DB ã‚’å†èª­è¾¼ã¿ã—ã¾ã™ã€‚
```

| é …ç›® | èª¬æ˜ |
|:--|:--|
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª** | DB ã‹ã‚‰å–å¾—ã—ãŸ Live é–¢é€£å‹•ç”»æ•° |
| **API æ›´æ–°** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ãã€API ã‹ã‚‰æ›´æ–°ã—ãŸå‹•ç”»æ•° |
| **DB æ›´æ–°** | åˆ†é¡çµæœã‚’ DB ã«åæ˜ ã—ãŸå‹•ç”»æ•° |

### ãƒ­ã‚°å‡ºåŠ›

```
[INFO] ğŸ¬ 3 ä»¶ã® Live å‹•ç”»ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒ»åˆ¤å®šä¸­...
[DEBUG] ğŸ“¡ API ã‹ã‚‰å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ 45 åˆ†å‰ï¼‰: dQw4w9WgXcQ
[DEBUG] ğŸ“¦ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼ˆ15 åˆ†å‰ï¼‰: jNQXAC9IVRw
[INFO] âœ… æ›´æ–°: dQw4w9WgXcQ (type=live, status=live)
[INFO] âœ… YouTube Live åˆ¤å®šå®Œäº†: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª 3 ä»¶ã€API æ›´æ–° 1 ä»¶ã€DB æ›´æ–° 2 ä»¶
```

---

## ã‚³ãƒ¼ãƒ‰ä¿®æ­£å†…å®¹

### ä¿®æ­£å‰

```python
# poll_lives() ã§å…¨ã¦ã®å‡¦ç†ï¼ˆåˆ†é¡ãƒ»æ¤œé‡ãƒ»æŠ•ç¨¿ï¼‰ã‚’å®Ÿè¡Œ
live_module = get_live_module(plugin_manager=self.plugin_manager)
processed_count = live_module.poll_lives()
```

### ä¿®æ­£å¾Œ

```python
# 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
timestamp = youtube_api_plugin.cache_timestamps.get(video_id, 0)
cache_age_seconds = current_time - timestamp
is_cache_old = cache_age_seconds > CACHE_VALIDITY_SECONDS

# 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„å ´åˆã®ã¿ API ã‹ã‚‰å–å¾—
if is_cache_old:
    classification_result = classifier.classify_video(video_id)
    refreshed_count += 1

# 3. åˆ†é¡çµæœã‚’ DB ã«åæ˜ ï¼ˆæŠ•ç¨¿ãªã—ï¼‰
success = db.update_video_status(video_id, content_type, live_status)
```

---

## DB ã¸ã®åæ˜ æ–¹æ³•

### update_video_status() ã®ä»•æ§˜

```python
db.update_video_status(
    video_id,
    content_type="live",      # "schedule", "live", "completed", "archive"
    live_status="live"         # "upcoming", "live", "completed", None
)
```

**å‹•ç”»å–å¾—ãƒ»æŠ•ç¨¿ãªã—**ï¼š
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œãªã„
- æŠ•ç¨¿é–¢é€£ã®å‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œãªã„
- DB ã® `content_type` ã¨ `live_status` ã‚«ãƒ©ãƒ ã®ã¿æ›´æ–°

---

## ä½¿ç”¨ä¾‹

### ã‚·ãƒŠãƒªã‚ª 1: ãƒ©ã‚¤ãƒ–ãŒé–‹å§‹ã—ãŸ

**åˆæœŸçŠ¶æ…‹:**
```
video_id: dQw4w9WgXcQ
content_type: schedule
live_status: upcoming
ã‚­ãƒ£ãƒƒã‚·ãƒ¥: 45 åˆ†å‰
```

**ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œ:**
1. API ã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¤ã„ï¼‰
2. åˆ†é¡ â†’ type=live, status=live
3. DB æ›´æ–° â†’ content_type="live", live_status="live"
4. **æŠ•ç¨¿ãªã—**

**çµæœ:**
```
content_type: live âœ…
live_status: live âœ…
```

### ã‚·ãƒŠãƒªã‚ª 2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ–°ã—ã„

**åˆæœŸçŠ¶æ…‹:**
```
video_id: jNQXAC9IVRw
content_type: live
live_status: live
ã‚­ãƒ£ãƒƒã‚·ãƒ¥: 15 åˆ†å‰
```

**ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œ:**
1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ–°ã—ã„ï¼‰
2. åˆ†é¡ â†’ type=live, status=liveï¼ˆå¤‰åŒ–ãªã—ï¼‰
3. DB æ›´æ–° â†’ content_type="live", live_status="live"ï¼ˆå¤‰åŒ–ãªã—ï¼‰
4. **æŠ•ç¨¿ãªã—**

**çµæœ:**
```
API æ›´æ–°: 0 ä»¶
DB æ›´æ–°: 1 ä»¶ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼‰
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q: "Live é–¢é€£å‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“" ã¨è¡¨ç¤ºã•ã‚Œã‚‹

**A**: DB ã« Live å‹•ç”»ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

- äº‹å‰ã«ã€Œãƒ•ã‚£ãƒ¼ãƒ‰æ‰‹å‹•æ›´æ–°ã€ãƒœã‚¿ãƒ³ã§ YouTube RSS ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„
- ã¾ãŸã¯æ‰‹å‹•ã§å‹•ç”»ã‚’è¿½åŠ ã—ã¦ãã ã•ã„

### Q: API æ›´æ–°ãŒ 0 ä»¶

**A**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ–°ã—ã„ï¼ˆ30åˆ†ä»¥å†…ï¼‰ã§ã™ã€‚

- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯è‡ªå‹•ã§æœ‰åŠ¹æœŸé™å†…ã«ä¿æŒã•ã‚Œã¾ã™
- API å‘¼ã³å‡ºã—ã‚’æ¸›ã‚‰ã™ãŸã‚ã®ä»•æ§˜ã§ã™

### Q: DB æ›´æ–°ãŒ 0 ä»¶

**A**: ä»¥ä¸‹ã®åŸå› ãŒè€ƒãˆã‚‰ã‚Œã¾ã™

1. åˆ†é¡å¤±æ•— â†’ ãƒ­ã‚°ã§ç¢ºèª
2. æ—¢ã«åŒã˜çŠ¶æ…‹ï¼ˆcontent_type, live_status ãŒå¤‰ã‚ã‚‰ãªã„ï¼‰
3. update_video_status() ãŒå¤±æ•— â†’ ãƒ­ã‚°ã§ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [youtube_video_classifier.py](youtube_core/youtube_video_classifier.py) - åˆ†é¡å™¨
- [database.py](database.py) - DB æ“ä½œï¼ˆupdate_video_statusï¼‰
- [youtube_api_plugin.py](plugins/youtube/youtube_api_plugin.py) - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

---

**å®Ÿè£…å®Œäº†æ—¥**: 2026-01-03
